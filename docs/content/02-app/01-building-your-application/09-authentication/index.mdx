---
title: è®¤è¯
description: äº†è§£å¦‚ä½•åœ¨æ‚¨çš„ Next.js åº”ç”¨ä¸­å®ç°è®¤è¯ã€‚
---

ç†è§£è®¤è¯å¯¹äºä¿æŠ¤åº”ç”¨çš„æ•°æ®è‡³å…³é‡è¦ã€‚æœ¬é¡µé¢å°†æŒ‡å¯¼æ‚¨å¦‚ä½•ä½¿ç”¨ React å’Œ Next.js çš„åŠŸèƒ½æ¥å®ç°è®¤è¯ã€‚

åœ¨å¼€å§‹ä¹‹å‰ï¼Œæœ€å¥½å°†è¿‡ç¨‹åˆ†ä¸ºä¸‰ä¸ªæ¦‚å¿µï¼š

1. **[è®¤è¯](#authentication)**: éªŒè¯ç”¨æˆ·æ˜¯å¦æ˜¯ä»–ä»¬æ‰€å£°ç§°çš„äººã€‚é€šå¸¸éœ€è¦ç”¨æˆ·æä¾›èº«ä»½éªŒè¯ä¿¡æ¯ï¼Œå¦‚ç”¨æˆ·åå’Œå¯†ç ã€‚
2. **[Session ç®¡ç†](#session-management)**: è·¨è¯·æ±‚è·Ÿè¸ªç”¨æˆ·çš„æˆæƒçŠ¶æ€ã€‚
3. **[æˆæƒ](#authorization)**: å†³å®šç”¨æˆ·å¯ä»¥è®¿é—®å“ªäº›è·¯ç”±å’Œæ•°æ®ã€‚

ä¸‹å›¾å±•ç¤ºäº†ä½¿ç”¨ React å’Œ Next.js åŠŸèƒ½çš„è®¤è¯æµç¨‹ï¼š

<img
  alt="Diagram showing the authentication flow with React and Next.js features"
  src="/authentication-overview.avif"
  width="100%"
  height="auto"
/>

æœ¬é¡µé¢ä¸Šçš„ç¤ºä¾‹æ¼”ç¤ºäº†ç”¨äºæ•™å­¦ç›®çš„çš„åŸºæœ¬ç”¨æˆ·åå’Œå¯†ç è®¤è¯ã€‚è™½ç„¶æ‚¨å¯ä»¥å®ç°è‡ªå®šä¹‰çš„è®¤è¯è§£å†³æ–¹æ¡ˆï¼Œä½†ä¸ºäº†æé«˜å®‰å…¨æ€§å’Œç®€åŒ–æµç¨‹ï¼Œæˆ‘ä»¬å»ºè®®ä½¿ç”¨è®¤è¯åº“ã€‚è¿™äº›åº“æä¾›å†…ç½®çš„è®¤è¯ã€ä¼šè¯ç®¡ç†å’Œæˆæƒè§£å†³æ–¹æ¡ˆï¼Œä»¥åŠè¯¸å¦‚ç¤¾äº¤ç™»å½•ã€å¤šå› ç´ è®¤è¯å’ŒåŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ç­‰é™„åŠ åŠŸèƒ½ã€‚åœ¨[Auth Libraries](#auth-libraries)éƒ¨åˆ†å¯ä»¥æ‰¾åˆ°ç›¸å…³åˆ—è¡¨ã€‚

## è®¤è¯

### æ³¨å†Œå’Œç™»å½•åŠŸèƒ½

æ‚¨å¯ä»¥ä½¿ç”¨[`<form>`](https://react.dev/reference/react-dom/components/form)å…ƒç´ ä¸ React çš„[Server Actions](/docs/content/app/building-your-application/data-fetching/server-actions-and-mutations)å’Œ[`useActionState()`](https://react.dev/reference/react/useActionState)æ¥æ•è·ç”¨æˆ·å‡­æ®ã€éªŒè¯è¡¨å•å­—æ®µï¼Œå¹¶è°ƒç”¨æ‚¨çš„è®¤è¯æä¾›å•†çš„ API æˆ–æ•°æ®åº“ã€‚

ç”±äº Server Actions å§‹ç»ˆåœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œï¼Œå®ƒä»¬æä¾›äº†ä¸€ä¸ªå®‰å…¨çš„ç¯å¢ƒæ¥å¤„ç†è®¤è¯é€»è¾‘ã€‚

ä»¥ä¸‹æ˜¯å®ç°æ³¨å†Œ/ç™»å½•åŠŸèƒ½çš„æ­¥éª¤ï¼š

#### 1. æ•è·ç”¨æˆ·å‡­æ®

è¦æ•è·ç”¨æˆ·å‡­æ®ï¼Œè¯·åˆ›å»ºä¸€ä¸ªè¡¨å•ï¼Œä½¿å…¶åœ¨æäº¤æ—¶è°ƒç”¨ Server Actionã€‚ä¾‹å¦‚ï¼Œä¸€ä¸ªæ¥å—ç”¨æˆ·åã€ç”µå­é‚®ä»¶å’Œå¯†ç çš„æ³¨å†Œè¡¨å•ï¼š

```tsx filename="app/ui/signup-form.tsx" switcher
import { signup } from "@/app/actions/auth";

export function SignupForm() {
  return (
    <form action={signup}>
      <div>
        <label htmlFor="name">Name</label>
        <input id="name" name="name" placeholder="Name" />
      </div>
      <div>
        <label htmlFor="email">Email</label>
        <input id="email" name="email" type="email" placeholder="Email" />
      </div>
      <div>
        <label htmlFor="password">Password</label>
        <input id="password" name="password" type="password" />
      </div>
      <button type="submit">Sign Up</button>
    </form>
  );
}
```

```jsx filename="app/ui/signup-form.js" switcher
import { signup } from "@/app/actions/auth";

export function SignupForm() {
  return (
    <form action={signup}>
      <div>
        <label htmlFor="name">Name</label>
        <input id="name" name="name" placeholder="Name" />
      </div>
      <div>
        <label htmlFor="email">Email</label>
        <input id="email" name="email" type="email" placeholder="Email" />
      </div>
      <div>
        <label htmlFor="password">Password</label>
        <input id="password" name="password" type="password" />
      </div>
      <button type="submit">Sign Up</button>
    </form>
  );
}
```

```tsx filename="app/actions/auth.tsx" switcher
export async function signup(formData: FormData) {}
```

```jsx filename="app/actions/auth.js" switcher
export async function signup(formData) {}
```

#### 2. åœ¨æœåŠ¡å™¨ä¸ŠéªŒè¯è¡¨å•å­—æ®µ

ä½¿ç”¨ Server Action åœ¨æœåŠ¡å™¨ä¸ŠéªŒè¯è¡¨å•å­—æ®µã€‚å¦‚æœæ‚¨çš„è®¤è¯æä¾›å•†ä¸æä¾›è¡¨å•éªŒè¯ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨åƒ[Zod](https://zod.dev/)æˆ–[Yup](https://github.com/jquense/yup)è¿™æ ·çš„æ¶æ„éªŒè¯åº“ã€‚

ä½¿ç”¨ Zod ä½œä¸ºç¤ºä¾‹ï¼Œæ‚¨å¯ä»¥å®šä¹‰ä¸€ä¸ªå…·æœ‰é€‚å½“é”™è¯¯æ¶ˆæ¯çš„è¡¨å•æ–¹æ¡ˆï¼š

```ts filename="app/lib/definitions.ts" switcher
import { z } from "zod";

export const SignupFormSchema = z.object({
  name: z
    .string()
    .min(2, { message: "Name must be at least 2 characters long." })
    .trim(),
  email: z.string().email({ message: "Please enter a valid email." }).trim(),
  password: z
    .string()
    .min(8, { message: "Be at least 8 characters long" })
    .regex(/[a-zA-Z]/, { message: "Contain at least one letter." })
    .regex(/[0-9]/, { message: "Contain at least one number." })
    .regex(/[^a-zA-Z0-9]/, {
      message: "Contain at least one special character.",
    })
    .trim(),
});

export type FormState =
  | {
      errors?: {
        name?: string[];
        email?: string[];
        password?: string[];
      };
      message?: string;
    }
  | undefined;
```

```js filename="app/lib/definitions.js" switcher
import { z } from "zod";

export const SignupFormSchema = z.object({
  name: z
    .string()
    .min(2, { message: "Name must be at least 2 characters long." })
    .trim(),
  email: z.string().email({ message: "Please enter a valid email." }).trim(),
  password: z
    .string()
    .min(8, { message: "Be at least 8 characters long" })
    .regex(/[a-zA-Z]/, { message: "Contain at least one letter." })
    .regex(/[0-9]/, { message: "Contain at least one number." })
    .regex(/[^a-zA-Z0-9]/, {
      message: "Contain at least one special character.",
    })
    .trim(),
});
```

ä¸ºé˜²æ­¢ä¸å¿…è¦åœ°è°ƒç”¨æ‚¨çš„è®¤è¯æä¾›å•†çš„ API æˆ–æ•°æ®åº“ï¼Œå¦‚æœè¡¨å•å­—æ®µä¸å®šä¹‰çš„æ¶æ„ä¸åŒ¹é…ï¼Œæ‚¨å¯ä»¥åœ¨`Server Action`ä¸­æå‰`return`ã€‚

```ts filename="app/actions/auth.ts" switcher
import { SignupFormSchema, FormState } from "@/app/lib/definitions";

export async function signup(state: FormState, formData: FormData) {
  // Validate form fields
  const validatedFields = SignupFormSchema.safeParse({
    name: formData.get("name"),
    email: formData.get("email"),
    password: formData.get("password"),
  });

  // If any form fields are invalid, return early
  if (!validatedFields.success) {
    return {
      errors: validatedFields.error.flatten().fieldErrors,
    };
  }

  // Call the provider or db to create a user...
}
```

```js filename="app/actions/auth.js" switcher
import { SignupFormSchema } from "@/app/lib/definitions";

export async function signup(state, formData) {
  // Validate form fields
  const validatedFields = SignupFormSchema.safeParse({
    name: formData.get("name"),
    email: formData.get("email"),
    password: formData.get("password"),
  });

  // If any form fields are invalid, return early
  if (!validatedFields.success) {
    return {
      errors: validatedFields.error.flatten().fieldErrors,
    };
  }

  // Call the provider or db to create a user...
}
```

å›åˆ°æ‚¨çš„`<SignupForm />`ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ React çš„`useActionState()` hook æ¥æ˜¾ç¤ºéªŒè¯é”™è¯¯å’Œè¡¨å•æäº¤ä¸­çš„æŒ‚èµ·çŠ¶æ€ï¼š

```tsx filename="app/ui/signup-form.tsx" switcher highlight={7,15,21,27-39}
"use client";

import { useActionState } from "react";
import { signup } from "@/app/actions/auth";

export function SignupForm() {
  const [state, action, pending] = useActionState(signup, undefined);

  return (
    <form action={action}>
      <div>
        <label htmlFor="name">Name</label>
        <input id="name" name="name" placeholder="Name" />
      </div>
      {state?.errors?.name && <p>{state.errors.name}</p>}

      <div>
        <label htmlFor="email">Email</label>
        <input id="email" name="email" placeholder="Email" />
      </div>
      {state?.errors?.email && <p>{state.errors.email}</p>}

      <div>
        <label htmlFor="password">Password</label>
        <input id="password" name="password" type="password" />
      </div>
      {state?.errors?.password && (
        <div>
          <p>Password must:</p>
          <ul>
            {state.errors.password.map((error) => (
              <li key={error}>- {error}</li>
            ))}
          </ul>
        </div>
      )}
      <button aria-disabled={pending} type="submit">
        {pending ? "Submitting..." : "Sign up"}
      </button>
    </form>
  );
}
```

```jsx filename="app/ui/signup-form.js" switcher highlight={7,15,21,27-39}
"use client";

import { useActionState } from "react";
import { signup } from "@/app/actions/auth";

export function SignupForm() {
  const [state, action, pending] = useActionState(signup, undefined);

  return (
    <form action={action}>
      <div>
        <label htmlFor="name">Name</label>
        <input id="name" name="name" placeholder="John Doe" />
      </div>
      {state.errors.name && <p>{state.errors.name}</p>}

      <div>
        <label htmlFor="email">Email</label>
        <input id="email" name="email" placeholder="john@example.com" />
      </div>
      {state.errors.email && <p>{state.errors.email}</p>}

      <div>
        <label htmlFor="password">Password</label>
        <input id="password" name="password" type="password" />
      </div>
      {state.errors.password && (
        <div>
          <p>Password must:</p>
          <ul>
            {state.errors.password.map((error) => (
              <li key={error}>- {error}</li>
            ))}
          </ul>
        </div>
      )}
      <button aria-disabled={pending} type="submit">
        {pending ? "Submitting..." : "Sign up"}
      </button>
    </form>
  );
}
```

> **æ‚¨éœ€è¦çŸ¥é“:** æˆ–è€…ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨[`useFormStatus`](https://react.dev/reference/react-dom/hooks/useFormStatus) hook æ¥æ˜¾ç¤ºæŒ‚èµ·çŠ¶æ€ã€‚

#### 3. åˆ›å»ºç”¨æˆ·æˆ–æ£€æŸ¥ç”¨æˆ·å‡­æ®

åœ¨éªŒè¯è¡¨å•å­—æ®µåï¼Œæ‚¨å¯ä»¥é€šè¿‡è°ƒç”¨æ‚¨çš„è®¤è¯æä¾›å•†çš„ API æˆ–æ•°æ®åº“æ¥åˆ›å»ºä¸€ä¸ªæ–°ç”¨æˆ·è´¦æˆ·æˆ–æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å­˜åœ¨ã€‚

ä»ä¸Šä¸€ä¸ªç¤ºä¾‹ç»§ç»­ï¼š

```tsx filename="app/actions/auth.tsx" switcher
export async function signup(state: FormState, formData: FormData) {
  // 1. Validate form fields
  // ...

  // 2. Prepare data for insertion into database
  const { name, email, password } = validatedFields.data;
  // e.g. Hash the user's password before storing it
  const hashedPassword = await bcrypt.hash(password, 10);

  // 3. Insert the user into the database or call an Auth Library's API
  const data = await db
    .insert(users)
    .values({
      name,
      email,
      password: hashedPassword,
    })
    .returning({ id: users.id });

  const user = data[0];

  if (!user) {
    return {
      message: "An error occurred while creating your account.",
    };
  }

  // TODO:
  // 4. Create user session
  // 5. Redirect user
}
```

```jsx filename="app/actions/auth.js" switcher
export async function signup(state, formData) {
  // 1. Validate form fields
  // ...

  // 2. Prepare data for insertion into database
  const { name, email, password } = validatedFields.data;
  // e.g. Hash the user's password before storing it
  const hashedPassword = await bcrypt.hash(password, 10);

  // 3. Insert the user into the database or call an Library API
  const data = await db
    .insert(users)
    .values({
      name,
      email,
      password: hashedPassword,
    })
    .returning({ id: users.id });

  const user = data[0];

  if (!user) {
    return {
      message: "An error occurred while creating your account.",
    };
  }

  // TODO:
  // 4. Create user session
  // 5. Redirect user
}
```

æˆåŠŸåˆ›å»ºç”¨æˆ·è´¦æˆ·æˆ–éªŒè¯ç”¨æˆ·å‡­æ®åï¼Œæ‚¨å¯ä»¥åˆ›å»ºä¸€ä¸ªä¼šè¯æ¥ç®¡ç†ç”¨æˆ·çš„è®¤è¯çŠ¶æ€ã€‚æ ¹æ®æ‚¨çš„ä¼šè¯ç®¡ç†ç­–ç•¥ï¼Œä¼šè¯å¯ä»¥å­˜å‚¨åœ¨ cookie æˆ–æ•°æ®åº“ä¸­ï¼Œæˆ–è€…åŒæ—¶å­˜å‚¨åœ¨ä¸¤è€…ä¸­ã€‚ç»§ç»­é˜…è¯»[ä¼šè¯ç®¡ç†](#session-management)ç« èŠ‚äº†è§£æ›´å¤šã€‚

> **æç¤º:**
>
> - ä¸Šè¿°ç¤ºä¾‹æ¯”è¾ƒå†—é•¿ï¼Œå› ä¸ºå®ƒè¯¦ç»†è§£é‡Šäº†è®¤è¯æ­¥éª¤ä»¥ç”¨äºæ•™å­¦ã€‚è¿™å¼ºè°ƒäº†å®ç°è‡ªå·±å®‰å…¨çš„è§£å†³æ–¹æ¡ˆå¾ˆå¿«å°±ä¼šå˜å¾—å¤æ‚ã€‚è€ƒè™‘ä½¿ç”¨[è®¤è¯åº“](#auth-libraries)æ¥ç®€åŒ–æµç¨‹ã€‚
> - ä¸ºäº†æ”¹å–„ç”¨æˆ·ä½“éªŒï¼Œæ‚¨å¯èƒ½å¸Œæœ›åœ¨æ³¨å†Œæµç¨‹ä¸­æ›´æ—©åœ°æ£€æŸ¥é‡å¤çš„ç”µå­é‚®ä»¶æˆ–ç”¨æˆ·åã€‚ä¾‹å¦‚ï¼Œåœ¨ç”¨æˆ·è¾“å…¥ç”¨æˆ·åæˆ–è¾“å…¥æ¡†å¤±å»ç„¦ç‚¹æ—¶è¿›è¡Œæ£€æŸ¥ã€‚è¿™æœ‰åŠ©äºé˜²æ­¢ä¸å¿…è¦çš„è¡¨å•æäº¤å¹¶ä¸ºç”¨æˆ·æä¾›å³æ—¶åé¦ˆã€‚æ‚¨å¯ä»¥ä½¿ç”¨åƒ[use-debounce](https://www.npmjs.com/package/use-debounce)è¿™æ ·çš„åº“æ¥ç®¡ç†è¿™äº›æ£€æŸ¥çš„é¢‘ç‡ã€‚

## Session ç®¡ç†

ä¼šè¯ç®¡ç†ç¡®ä¿ç”¨æˆ·çš„è®¤è¯çŠ¶æ€åœ¨å¤šä¸ªè¯·æ±‚ä¹‹é—´ä¿æŒã€‚å®ƒæ¶‰åŠåˆ›å»ºã€å­˜å‚¨ã€åˆ·æ–°å’Œåˆ é™¤ä¼šè¯æˆ–ä»¤ç‰Œã€‚

ä¼šè¯æœ‰ä¸¤ç§ç±»å‹ï¼š

1. [**æ— çŠ¶æ€ä¼šè¯**](#stateless-sessions): ä¼šè¯æ•°æ®ï¼ˆæˆ–ä»¤ç‰Œï¼‰å­˜å‚¨åœ¨æµè§ˆå™¨çš„ cookie ä¸­ã€‚cookie éšæ¯ä¸ªè¯·æ±‚å‘é€ï¼Œå…è®¸æœåŠ¡å™¨éªŒè¯ä¼šè¯ã€‚è¿™ç§æ–¹æ³•æ›´ç®€å•ï¼Œä½†å¦‚æœæ²¡æœ‰æ­£ç¡®å®ç°ï¼Œå¯èƒ½ä¸å¤ªå®‰å…¨ã€‚
2. [**æ•°æ®åº“ä¼šè¯**](#database-sessions): ä¼šè¯æ•°æ®å­˜å‚¨åœ¨æ•°æ®åº“ä¸­ï¼Œç”¨æˆ·çš„æµè§ˆå™¨åªæ¥æ”¶åŠ å¯†çš„ä¼šè¯ IDã€‚è¿™ç§æ–¹æ³•æ›´å®‰å…¨ï¼Œä½†å®ç°èµ·æ¥æ›´å¤æ‚ï¼Œå¹¶ä¸”ä¼šæ¶ˆè€—æ›´å¤šçš„æœåŠ¡å™¨èµ„æºã€‚

> **æ‚¨éœ€è¦çŸ¥é“:** è™½ç„¶æ‚¨å¯ä»¥ä½¿ç”¨ä»»æ„ä¸€ç§æ–¹æ³•ï¼Œç”šè‡³åŒæ—¶ä½¿ç”¨ä¸¤ç§æ–¹æ³•ï¼Œä½†æˆ‘ä»¬å»ºè®®ä½¿ç”¨åƒ[iron-session](https://github.com/vvo/iron-session) æˆ– [Jose](https://github.com/panva/jose)è¿™æ ·çš„ä¼šè¯ç®¡ç†åº“ã€‚

### Stateless Sessions

è¦åˆ›å»ºå’Œç®¡ç†æ— çŠ¶æ€ä¼šè¯ï¼Œæ‚¨éœ€è¦éµå¾ªä»¥ä¸‹æ­¥éª¤ï¼š

1. ç”Ÿæˆä¸€ä¸ªå¯†é’¥ï¼Œè¯¥å¯†é’¥å°†ç”¨äºç­¾ç½²æ‚¨çš„ä¼šè¯ï¼Œå¹¶å°†å…¶ä½œä¸º[ç¯å¢ƒå˜é‡å­˜å‚¨](/docs/content/app/building-your-application/configuring/environment-variables)ã€‚
2. ä½¿ç”¨ä¼šè¯ç®¡ç†åº“ç¼–å†™åŠ å¯†/è§£å¯†ä¼šè¯æ•°æ®çš„é€»è¾‘ã€‚
3. ä½¿ç”¨ Next.js çš„ [`cookies()`](/docs/content/app/api-reference/functions/cookies)API ç®¡ç† cookiesã€‚

é™¤äº†ä»¥ä¸Šå†…å®¹å¤–ï¼Œå»ºè®®æ·»åŠ åŠŸèƒ½æ¥åœ¨ç”¨æˆ·è¿”å›åº”ç”¨ç¨‹åºæ—¶[æ›´æ–°ï¼ˆæˆ–åˆ·æ–°ï¼‰](#updating-or-refreshing-sessions)ä¼šè¯ï¼Œå¹¶åœ¨ç”¨æˆ·æ³¨é”€æ—¶[åˆ é™¤](#deleting-the-session)ä¼šè¯ã€‚

> **æ‚¨éœ€è¦çŸ¥é“:** æ£€æŸ¥æ‚¨çš„[è®¤è¯åº“](#auth-libraries)æ˜¯å¦åŒ…å«ä¼šè¯ç®¡ç†åŠŸèƒ½ã€‚

#### 1. ç”Ÿæˆå¯†é’¥

æœ‰å‡ ç§æ–¹æ³•å¯ä»¥ç”Ÿæˆç”¨äºç­¾ç½²ä¼šè¯çš„å¯†é’¥ã€‚ä¾‹å¦‚ï¼Œæ‚¨å¯ä»¥åœ¨ç»ˆç«¯ä¸­ä½¿ç”¨`openssl`å‘½ä»¤ï¼š

```bash filename="terminal"
openssl rand -base64 32
```

æ­¤å‘½ä»¤ä¼šç”Ÿæˆä¸€ä¸ª 32 ä¸ªå­—ç¬¦çš„éšæœºå­—ç¬¦ä¸²ï¼Œæ‚¨å¯ä»¥å°†å…¶ç”¨ä½œå¯†é’¥ï¼Œå¹¶å°†å…¶å­˜å‚¨åœ¨æ‚¨çš„[ç¯å¢ƒå˜é‡æ–‡ä»¶ä¸­](/docs/content/app/building-your-application/configuring/environment-variables)ï¼š

```bash filename=".env"
SESSION_SECRET=your_secret_key
```

ç„¶åæ‚¨å¯ä»¥åœ¨ä¼šè¯ç®¡ç†é€»è¾‘ä¸­å¼•ç”¨è¯¥å¯†é’¥ï¼š

```js filename="app/lib/session.js"
const secretKey = process.env.SESSION_SECRET;
```

#### 2. åŠ å¯†å’Œè§£å¯†ä¼šè¯

æ¥ä¸‹æ¥ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨æ‚¨å–œæ¬¢çš„[ä¼šè¯ç®¡ç†åº“](#session-management-libraries)æ¥åŠ å¯†å’Œè§£å¯†ä¼šè¯ã€‚ç»§ç»­ä¸Šé¢çš„ä¾‹å­ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨[Jose](https://www.npmjs.com/package/jose)ï¼ˆä¸[Edge è¿è¡Œæ—¶](/docs/content/app/building-your-application/rendering/edge-and-nodejs-runtimes)å…¼å®¹ï¼‰å’Œ React çš„[`server-only`](https://www.npmjs.com/package/server-only)ï¼Œä»¥ç¡®ä¿ä¼šè¯ç®¡ç†é€»è¾‘ä»…åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œã€‚

```tsx filename="app/lib/session.ts" switcher
import "server-only";
import { SignJWT, jwtVerify } from "jose";
import { SessionPayload } from "@/app/lib/definitions";

const secretKey = process.env.SESSION_SECRET;
const encodedKey = new TextEncoder().encode(secretKey);

export async function encrypt(payload: SessionPayload) {
  return new SignJWT(payload)
    .setProtectedHeader({ alg: "HS256" })
    .setIssuedAt()
    .setExpirationTime("7d")
    .sign(encodedKey);
}

export async function decrypt(session: string | undefined = "") {
  try {
    const { payload } = await jwtVerify(session, encodedKey, {
      algorithms: ["HS256"],
    });
    return payload;
  } catch (error) {
    console.log("Failed to verify session");
  }
}
```

```jsx filename="app/lib/session.js" switcher
import "server-only";
import { SignJWT, jwtVerify } from "jose";

const secretKey = process.env.SESSION_SECRET;
const encodedKey = new TextEncoder().encode(secretKey);

export async function encrypt(payload) {
  return new SignJWT(payload)
    .setProtectedHeader({ alg: "HS256" })
    .setIssuedAt()
    .setExpirationTime("7d")
    .sign(encodedKey);
}

export async function decrypt(session) {
  try {
    const { payload } = await jwtVerify(session, encodedKey, {
      algorithms: ["HS256"],
    });
    return payload;
  } catch (error) {
    console.log("Failed to verify session");
  }
}
```

> **æç¤º**:
>
> æœ‰æ•ˆè½½è·åº”ä»…åŒ…å«åœ¨åç»­è¯·æ±‚ä¸­ä½¿ç”¨çš„**æœ€å°‘**ã€å”¯ä¸€çš„ç”¨æˆ·æ•°æ®ï¼Œå¦‚ç”¨æˆ· IDã€è§’è‰²ç­‰ã€‚ä¸åº”åŒ…å«è¯¸å¦‚ç”µè¯å·ç ã€ç”µå­é‚®ä»¶åœ°å€ã€ä¿¡ç”¨å¡ä¿¡æ¯ç­‰ä¸ªäººèº«ä»½ä¿¡æ¯ï¼Œä¹Ÿä¸åº”åŒ…å«å¯†ç ç­‰æ•æ„Ÿæ•°æ®ã€‚

#### 3. è®¾ç½® cookies (æ¨èé€‰æ‹©)

è¦åœ¨ cookie ä¸­å­˜å‚¨ä¼šè¯ï¼Œè¯·ä½¿ç”¨ Next.js çš„[`cookies()`](/docs/content/app/api-reference/functions/cookies)APIã€‚cookie åº”è¯¥åœ¨æœåŠ¡å™¨ä¸Šè®¾ç½®ï¼Œå¹¶åŒ…å«ä»¥ä¸‹æ¨èé€‰é¡¹ï¼š

- **HttpOnly**: é˜²æ­¢å®¢æˆ·ç«¯ JavaScript è®¿é—® cookieã€‚
- **Secure**: ä½¿ç”¨ https å‘é€ cookieã€‚
- **SameSite**: æŒ‡å®šæ˜¯å¦å…è®¸ cookie éšè·¨ç«™ç‚¹è¯·æ±‚å‘é€ã€‚
- **Max-Age or Expires**: åœ¨æŒ‡å®šæ—¶é—´ååˆ é™¤ cookieã€‚
- **Path**: å®šä¹‰ cookie çš„ URL è·¯å¾„ã€‚

è¯·å‚è€ƒ[MDN](https://developer.mozilla.org/en-US/docs/Web/HTTP/Cookies)è·å–æœ‰å…³è¿™äº›é€‰é¡¹çš„æ›´å¤šä¿¡æ¯ã€‚

```ts filename="app/lib/session.ts" switcher
import "server-only";
import { cookies } from "next/headers";

export async function createSession(userId: string) {
  const expiresAt = new Date(Date.now() + 7 * 24 * 60 * 60 * 1000);
  const session = await encrypt({ userId, expiresAt });

  cookies().set("session", session, {
    httpOnly: true,
    secure: true,
    expires: expiresAt,
    sameSite: "lax",
    path: "/",
  });
}
```

```js filename="app/lib/session.js" switcher
import "server-only";
import { cookies } from "next/headers";

export async function createSession(userId) {
  const expiresAt = new Date(Date.now() + 7 * 24 * 60 * 60 * 1000);
  const session = await encrypt({ userId, expiresAt });

  cookies().set("session", session, {
    httpOnly: true,
    secure: true,
    expires: expiresAt,
    sameSite: "lax",
    path: "/",
  });
}
```

åœ¨æ‚¨çš„æœåŠ¡å™¨æ“ä½œä¸­ï¼Œæ‚¨å¯ä»¥è°ƒç”¨`createSession()`å‡½æ•°ï¼Œå¹¶ä½¿ç”¨[`redirect()`](/docs/content/app/building-your-application/routing/redirecting)å°†ç”¨æˆ·é‡å®šå‘åˆ°åˆé€‚çš„é¡µé¢ï¼š

```ts filename="app/actions/auth.ts" switcher
import { createSession } from "@/app/lib/session";

export async function signup(state: FormState, formData: FormData) {
  // Previous steps:
  // 1. Validate form fields
  // 2. Prepare data for insertion into database
  // 3. Insert the user into the database or call an Library API

  // Current steps:
  // 4. Create user session
  await createSession(user.id);
  // 5. Redirect user
  redirect("/profile");
}
```

```js filename="app/actions/auth.js" switcher
import { createSession } from "@/app/lib/session";

export async function signup(state, formData) {
  // Previous steps:
  // 1. Validate form fields
  // 2. Prepare data for insertion into database
  // 3. Insert the user into the database or call an Library API

  // Current steps:
  // 4. Create user session
  await createSession(user.id);
  // 5. Redirect user
  redirect("/profile");
}
```

> **æç¤º**:
>
> - **Cookie åº”åœ¨æœåŠ¡å™¨ä¸Šè®¾ç½®** ä»¥é˜²æ­¢å®¢æˆ·ç«¯ç¯¡æ”¹ã€‚
> - ğŸ¥ è§‚çœ‹: äº†è§£æœ‰å…³ Next.js æ— çŠ¶æ€ä¼šè¯å’Œèº«ä»½éªŒè¯çš„æ›´å¤šä¿¡æ¯ â†’ [YouTube (11 åˆ†é’Ÿ)](https://www.youtube.com/watch?v=DJvM2lSPn6w).

#### æ›´æ–° (æˆ–åˆ·æ–°) sessions

æ‚¨è¿˜å¯ä»¥æ‰©å±•ä¼šè¯çš„è¿‡æœŸæ—¶é—´ã€‚è¿™å¯¹äºç”¨æˆ·é‡æ–°è®¿é—®åº”ç”¨ç¨‹åºåä¿æŒç™»å½•çŠ¶æ€éå¸¸æœ‰ç”¨ã€‚ä¾‹å¦‚ï¼š

```ts filename="app/lib/session.ts" switcher
import "server-only";
import { cookies } from "next/headers";
import { decrypt } from "@/app/lib/session";

export async function updateSession() {
  const session = cookies().get("session")?.value;
  const payload = await decrypt(session);

  if (!session || !payload) {
    return null;
  }

  const expires = new Date(Date.now() + 7 * 24 * 60 * 60 * 1000);
  cookies().set("session", session, {
    httpOnly: true,
    secure: true,
    expires: expires,
    sameSite: "lax",
    path: "/",
  });
}
```

```js filename="app/lib/session.js" switcher
import "server-only";
import { cookies } from "next/headers";
import { decrypt } from "@/app/lib/session";

export async function updateSession() {
  const session = cookies().get("session").value;
  const payload = await decrypt(session);

  if (!session || !payload) {
    return null;
  }

  const expires = new Date(Date.now() + 7 * 24 * 60 * 60 * 1000);
  cookies().set("session", session, {
    httpOnly: true,
    secure: true,
    expires: expires,
    sameSite: "lax",
    path: "/",
  });
}
```

> **æç¤º:** æ£€æŸ¥æ‚¨çš„èº«ä»½éªŒè¯åº“æ˜¯å¦æ”¯æŒåˆ·æ–°ä»¤ç‰Œï¼Œè¿™å¯ä»¥ç”¨äºæ‰©å±•ç”¨æˆ·ä¼šè¯ã€‚

#### åˆ é™¤ session

è¦åˆ é™¤ä¼šè¯ï¼Œå¯ä»¥åˆ é™¤ cookieï¼š

```ts filename="app/lib/session.ts" switcher
import "server-only";
import { cookies } from "next/headers";

export function deleteSession() {
  cookies().delete("session");
}
```

```js filename="app/lib/session.js" switcher
import "server-only";
import { cookies } from "next/headers";

export function deleteSession() {
  cookies().delete("session");
}
```

ç„¶åæ‚¨å¯ä»¥åœ¨åº”ç”¨ç¨‹åºä¸­é‡ç”¨`deleteSession()`å‡½æ•°ï¼Œä¾‹å¦‚åœ¨ç”¨æˆ·æ³¨é”€æ—¶ï¼š

```ts filename="app/actions/auth.ts" switcher
import { cookies } from "next/headers";
import { deleteSession } from "@/app/lib/session";

export async function logout() {
  deleteSession();
  redirect("/login");
}
```

```js filename="app/actions/auth.js" switcher
import { cookies } from "next/headers";
import { deleteSession } from "@/app/lib/session";

export async function logout() {
  deleteSession();
  redirect("/login");
}
```

### Database Sessions

è¦åˆ›å»ºå’Œç®¡ç†æ•°æ®åº“ä¼šè¯ï¼Œæ‚¨éœ€è¦éµå¾ªä»¥ä¸‹æ­¥éª¤ï¼š

1. åœ¨æ•°æ®åº“ä¸­åˆ›å»ºä¸€ä¸ªè¡¨æ¥å­˜å‚¨ä¼šè¯å’Œæ•°æ®ï¼ˆæˆ–æ£€æŸ¥æ‚¨çš„è®¤è¯åº“æ˜¯å¦å¤„ç†æ­¤åŠŸèƒ½ï¼‰ã€‚
2. å®ç°æ’å…¥ã€æ›´æ–°å’Œåˆ é™¤ä¼šè¯çš„åŠŸèƒ½ã€‚
3. åœ¨å­˜å‚¨åˆ°ç”¨æˆ·æµè§ˆå™¨ä¹‹å‰åŠ å¯†ä¼šè¯ IDï¼Œå¹¶ç¡®ä¿æ•°æ®åº“å’Œ cookie ä¿æŒåŒæ­¥ï¼ˆæ­¤æ­¥éª¤æ˜¯å¯é€‰çš„ï¼Œä½†æ¨èç”¨äº [Middleware](#optimistic-checks-with-middleware-optional)ä¸­çš„ä¹è§‚éªŒè¯ï¼‰ã€‚

For example:

```ts filename="app/lib/session.ts" switcher
import cookies from "next/headers";
import { db } from "@/app/lib/db";
import { encrypt } from "@/app/lib/session";

export async function createSession(id: number) {
  const expiresAt = new Date(Date.now() + 7 * 24 * 60 * 60 * 1000);

  // 1. Create a session in the database
  const data = await db
    .insert(sessions)
    .values({
      userId: id,
      expiresAt,
    })
    // Return the session ID
    .returning({ id: sessions.id });

  const sessionId = data[0].id;

  // 2. Encrypt the session ID
  const session = await encrypt({ sessionId, expiresAt });

  // 3. Store the session in cookies for optimistic auth checks
  cookies().set("session", session, {
    httpOnly: true,
    secure: true,
    expires: expiresAt,
    sameSite: "lax",
    path: "/",
  });
}
```

```js filename="app/lib/session.js" switcher
import cookies from "next/headers";
import { db } from "@/app/lib/db";
import { encrypt } from "@/app/lib/session";

export async function createSession(id) {
  const expiresAt = new Date(Date.now() + 7 * 24 * 60 * 60 * 1000);

  // 1. Create a session in the database
  const data = await db
    .insert(sessions)
    .values({
      userId: id,
      expiresAt,
    })
    // Return the session ID
    .returning({ id: sessions.id });

  const sessionId = data[0].id;

  // 2. Encrypt the session ID
  const session = await encrypt({ sessionId, expiresAt });

  // 3. Store the session in cookies for optimistic auth checks
  cookies().set("session", session, {
    httpOnly: true,
    secure: true,
    expires: expiresAt,
    sameSite: "lax",
    path: "/",
  });
}
```

> **æç¤º**:
>
> - ä¸ºäº†æ›´å¿«åœ°æ£€ç´¢æ•°æ®ï¼Œæ‚¨å¯ä»¥è€ƒè™‘ä½¿ç”¨ç±»ä¼¼[Vercel Redis](https://vercel.com/docs/storage/vercel-kv)çš„æ•°æ®åº“ã€‚ç„¶è€Œï¼Œæ‚¨ä¹Ÿå¯ä»¥å°†ä¼šè¯æ•°æ®ä¿ç•™åœ¨ä¸»æ•°æ®åº“ä¸­ï¼Œå¹¶ç»“åˆæ•°æ®è¯·æ±‚æ¥å‡å°‘æŸ¥è¯¢æ¬¡æ•°ã€‚
> - æ‚¨å¯ä»¥é€‰æ‹©ä½¿ç”¨æ•°æ®åº“ä¼šè¯æ¥å¤„ç†æ›´é«˜çº§çš„ç”¨ä¾‹ï¼Œä¾‹å¦‚è·Ÿè¸ªç”¨æˆ·ä¸Šæ¬¡ç™»å½•æ—¶é—´æˆ–æ´»è·ƒè®¾å¤‡æ•°é‡ï¼Œæˆ–è®©ç”¨æˆ·æœ‰èƒ½åŠ›æ³¨é”€æ‰€æœ‰è®¾å¤‡ã€‚

å®ç°ä¼šè¯ç®¡ç†åï¼Œæ‚¨éœ€è¦æ·»åŠ æˆæƒé€»è¾‘æ¥æ§åˆ¶ç”¨æˆ·å¯ä»¥åœ¨åº”ç”¨ç¨‹åºä¸­è®¿é—®çš„å†…å®¹å’Œæ‰§è¡Œçš„æ“ä½œã€‚ç»§ç»­é˜…è¯»[æˆæƒ](#authorization)éƒ¨åˆ†ä»¥äº†è§£æ›´å¤šä¿¡æ¯ã€‚

## Authorization

ä¸€æ—¦ç”¨æˆ·ç»è¿‡èº«ä»½éªŒè¯å¹¶åˆ›å»ºäº†ä¼šè¯ï¼Œæ‚¨å¯ä»¥å®æ–½æˆæƒæ¥æ§åˆ¶ç”¨æˆ·åœ¨åº”ç”¨ç¨‹åºä¸­å¯ä»¥è®¿é—®å’Œæ‰§è¡Œçš„æ“ä½œã€‚

ä¸»è¦æœ‰ä¸¤ç§æˆæƒæ£€æŸ¥ç±»å‹ï¼š

1. **Optimistic**: ä½¿ç”¨å­˜å‚¨åœ¨ cookie ä¸­çš„ä¼šè¯æ•°æ®æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰æƒè®¿é—®æŸä¸ªè·¯ç”±æˆ–æ‰§è¡ŒæŸä¸ªæ“ä½œã€‚è¿™äº›æ£€æŸ¥é€‚ç”¨äºå¿«é€Ÿæ“ä½œï¼Œä¾‹å¦‚æ ¹æ®æƒé™æˆ–è§’è‰²æ˜¾ç¤º/éšè— UI å…ƒç´ æˆ–é‡å®šå‘ç”¨æˆ·ã€‚
2. **Secure**: ä½¿ç”¨å­˜å‚¨åœ¨æ•°æ®åº“ä¸­çš„ä¼šè¯æ•°æ®æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰æƒè®¿é—®æŸä¸ªè·¯ç”±æˆ–æ‰§è¡ŒæŸä¸ªæ“ä½œã€‚è¿™äº›æ£€æŸ¥æ›´åŠ å®‰å…¨ï¼Œé€‚ç”¨äºéœ€è¦è®¿é—®æ•æ„Ÿæ•°æ®æˆ–æ“ä½œçš„åœºæ™¯ã€‚

å¯¹äºè¿™ä¸¤ç§æƒ…å†µï¼Œæˆ‘ä»¬å»ºè®®ï¼š

- åˆ›å»ºä¸€ä¸ª [æ•°æ®è®¿é—®å±‚](#creating-a-data-access-layer-dal) æ¥é›†ä¸­æ‚¨çš„æˆæƒé€»è¾‘ã€‚
- ä½¿ç”¨[æ•°æ®ä¼ è¾“å¯¹è±¡ (DTO)](#using-data-transfer-objects-dto)ä»¥ä»…è¿”å›å¿…è¦çš„æ•°æ®ã€‚
- å¯é€‰åœ°[Middleware](#optimistic-checks-with-middleware-optional)æ¥æ‰§è¡Œä¹è§‚æ£€æŸ¥ã€‚

### ä¸­é—´ä»¶ä¸­çš„ä¹è§‚æ£€æŸ¥ï¼ˆå¯é€‰ï¼‰

åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œæ‚¨å¯èƒ½å¸Œæœ›ä½¿ç”¨[Middleware](/docs/content/app/building-your-application/routing/middleware) å¹¶æ ¹æ®æƒé™é‡å®šå‘ç”¨æˆ·ï¼š

- æ‰§è¡Œ optimistic checksã€‚ç”±äºä¸­é—´ä»¶è¿è¡Œåœ¨æ¯ä¸ªè·¯ç”±ä¸Šï¼Œ æ‰€ä»¥é›†ä¸­é‡å®šå‘é€»è¾‘å’Œé¢„è¿‡æ»¤æœªç»æˆæƒçš„ç”¨æˆ·éå¸¸é€‚åˆã€‚
- ä¿æŠ¤åœ¨ç”¨æˆ·ä¹‹é—´å…±äº«æ•°æ®çš„é™æ€è·¯ç”±ï¼ˆä¾‹å¦‚åœ¨ä»˜è´¹å¢™åé¢çš„å†…å®¹ï¼‰

ç„¶è€Œï¼Œç”±äºä¸­é—´ä»¶è¿è¡Œåœ¨æ¯ä¸ªè·¯ç”±ä¸Šï¼ŒåŒ…æ‹¬[é¢„åŠ è½½](/docs/content/app/building-your-application/routing/linking-and-navigating#2-prefetching)çš„è·¯ç”±ï¼Œå› æ­¤ä»…åº”ä» cookie ä¸­è¯»å–ä¼šè¯ï¼ˆä¹è§‚æ£€æŸ¥ï¼‰ï¼Œå¹¶é¿å…æ•°æ®åº“æ£€æŸ¥ä»¥é˜²æ­¢æ€§èƒ½é—®é¢˜æ˜¯éå¸¸é‡è¦çš„ã€‚

ä¾‹å¦‚:

```tsx filename="middleware.ts" switcher
import { NextRequest, NextResponse } from "next/server";
import { decrypt } from "@/app/lib/session";
import { cookies } from "next/headers";

// 1. Specify protected and public routes
const protectedRoutes = ["/dashboard"];
const publicRoutes = ["/login", "/signup", "/"];

export default async function middleware(req: NextRequest) {
  // 2. Check if the current route is protected or public
  const path = req.nextUrl.pathname;
  const isProtectedRoute = protectedRoutes.includes(path);
  const isPublicRoute = publicRoutes.includes(path);

  // 3. Decrypt the session from the cookie
  const cookie = cookies().get("session")?.value;
  const session = await decrypt(cookie);

  // 5. Redirect to /login if the user is not authenticated
  if (isProtectedRoute && !session?.userId) {
    return NextResponse.redirect(new URL("/login", req.nextUrl));
  }

  // 6. Redirect to /dashboard if the user is authenticated
  if (
    isPublicRoute &&
    session?.userId &&
    !req.nextUrl.pathname.startsWith("/dashboard")
  ) {
    return NextResponse.redirect(new URL("/dashboard", req.nextUrl));
  }

  return NextResponse.next();
}

// Routes Middleware should not run on
export const config = {
  matcher: ["/((?!api|_next/static|_next/image|.*\\.png$).*)"],
};
```

```js filename="middleware.js" switcher
import { NextResponse } from "next/server";
import { decrypt } from "@/app/lib/session";
import { cookies } from "next/headers";

// 1. Specify protected and public routes
const protectedRoutes = ["/dashboard"];
const publicRoutes = ["/login", "/signup", "/"];

export default async function middleware(req) {
  // 2. Check if the current route is protected or public
  const path = req.nextUrl.pathname;
  const isProtectedRoute = protectedRoutes.includes(path);
  const isPublicRoute = publicRoutes.includes(path);

  // 3. Decrypt the session from the cookie
  const cookie = cookies().get("session")?.value;
  const session = await decrypt(cookie);

  // 5. Redirect to /login if the user is not authenticated
  if (isProtectedRoute && !session?.userId) {
    return NextResponse.redirect(new URL("/login", req.nextUrl));
  }

  // 6. Redirect to /dashboard if the user is authenticated
  if (
    isPublicRoute &&
    session?.userId &&
    !req.nextUrl.pathname.startsWith("/dashboard")
  ) {
    return NextResponse.redirect(new URL("/dashboard", req.nextUrl));
  }

  return NextResponse.next();
}

// Routes Middleware should not run on
export const config = {
  matcher: ["/((?!api|_next/static|_next/image|.*\\.png$).*)"],
};
```

å°½ç®¡ä¸­é—´ä»¶å¯ä»¥ç”¨äºåˆå§‹æ£€æŸ¥ï¼Œä½†å®ƒä¸åº”æ˜¯ä¿æŠ¤æ•°æ®çš„å”¯ä¸€é˜²çº¿ã€‚å¤§å¤šæ•°å®‰å…¨æ£€æŸ¥åº”å°½å¯èƒ½æ¥è¿‘æ•°æ®æºè¿›è¡Œï¼Œæ›´å¤šä¿¡æ¯è¯·å‚è§[æ•°æ®è®¿é—®å±‚](#creating-a-data-access-layer-dal)ã€‚

> **æç¤º**:
>
> - åœ¨ä¸­é—´ä»¶ä¸­ï¼Œæ‚¨è¿˜å¯ä»¥ä½¿ç”¨`req.cookies.get('session).value`è¯»å– cookieã€‚
> - ä¸­é—´ä»¶ä½¿ç”¨[Edge Runtime](/docs/content/app/building-your-application/rendering/edge-and-nodejs-runtimes), ä»¥æ£€æŸ¥æ‚¨çš„èº«ä»½éªŒè¯åº“å’Œä¼šè¯ç®¡ç†åº“æ˜¯å¦å…¼å®¹ã€‚
> - æ‚¨å¯ä»¥ä½¿ç”¨ä¸­é—´ä»¶çš„`matcher`å±æ€§æŒ‡å®šä¸­é—´ä»¶åº”åœ¨å“ªäº›è·¯ç”±ä¸Šè¿è¡Œã€‚ä½†æ˜¯ï¼Œå¯¹äºèº«ä»½éªŒè¯ï¼Œå»ºè®®åœ¨æ‰€æœ‰è·¯ç”±ä¸Šè¿è¡Œä¸­é—´ä»¶ã€‚

### Creating a Data Access Layer (DAL)

æˆ‘ä»¬å»ºè®®åˆ›å»ºä¸€ä¸ª DAL æ¥é›†ä¸­æ‚¨çš„æ•°æ®è¯·æ±‚å’Œæˆæƒé€»è¾‘ã€‚

DAL åº”åŒ…æ‹¬ä¸€ä¸ªå‡½æ•°ï¼Œç”¨äºåœ¨ç”¨æˆ·ä¸åº”ç”¨ç¨‹åºäº¤äº’æ—¶éªŒè¯å…¶ä¼šè¯ã€‚è‡³å°‘ï¼Œå‡½æ•°åº”æ£€æŸ¥ä¼šè¯æ˜¯å¦æœ‰æ•ˆï¼Œç„¶åé‡å®šå‘æˆ–è¿”å›è¿›è¡Œè¿›ä¸€æ­¥è¯·æ±‚æ‰€éœ€çš„ç”¨æˆ·ä¿¡æ¯ã€‚

ä¾‹å¦‚ï¼Œåˆ›å»ºä¸€ä¸ªå•ç‹¬çš„æ–‡ä»¶æ¥åŒ…å«`verifySession()`å‡½æ•°ã€‚ç„¶åä½¿ç”¨ React çš„ [cache](https://react.dev/reference/react/cache) API æ¥åœ¨ React æ¸²æŸ“è¿‡ç¨‹ä¸­ç¼“å­˜å‡½æ•°çš„è¿”å›å€¼ï¼š

```tsx filename="app/lib/dal.ts" switcher
import "server-only";

import { cookies } from "next/headers";
import { decrypt } from "@/app/lib/session";

export const verifySession = cache(async () => {
  const cookie = cookies().get("session")?.value;
  const session = await decrypt(cookie);

  if (!session?.userId) {
    redirect("/login");
  }

  return { isAuth: true, userId: session.userId };
});
```

```js filename="app/lib/dal.js" switcher
import "server-only";

import { cookies } from "next/headers";
import { decrypt } from "@/app/lib/session";

export const verifySession = cache(async () => {
  const cookie = cookies().get("session").value;
  const session = await decrypt(cookie);

  if (!session.userId) {
    redirect("/login");
  }

  return { isAuth: true, userId: session.userId };
});
```

ç„¶åï¼Œæ‚¨å¯ä»¥åœ¨æ•°æ®è¯·æ±‚ã€æœåŠ¡å™¨æ“ä½œå’Œè·¯ç”±å¤„ç†ç¨‹åºä¸­è°ƒç”¨`verifySession()`å‡½æ•°ï¼š

```tsx filename="app/lib/dal.ts" switcher
export const getUser = cache(async () => {
  const session = await verifySession();
  if (!session) return null;

  try {
    const data = await db.query.users.findMany({
      where: eq(users.id, session.userId),
      // Explicitly return the columns you need rather than the whole user object
      columns: {
        id: true,
        name: true,
        email: true,
      },
    });

    const user = data[0];

    return user;
  } catch (error) {
    console.log("Failed to fetch user");
    return null;
  }
});
```

```jsx filename="app/lib/dal.js" switcher
export const getUser = cache(async () => {
  const session = await verifySession();
  if (!session) return null;

  try {
    const data = await db.query.users.findMany({
      where: eq(users.id, session.userId),
      // Explicitly return the columns you need rather than the whole user object
      columns: {
        id: true,
        name: true,
        email: true,
      },
    });

    const user = data[0];

    return user;
  } catch (error) {
    console.log("Failed to fetch user");
    return null;
  }
});
```

> **æç¤º**:
>
> - æ•°æ®è®¿é—®å±‚ (DAL) å¯ä»¥ç”¨æ¥ä¿æŠ¤åœ¨è¯·æ±‚æ—¶è·å–çš„æ•°æ®ã€‚ç„¶è€Œï¼Œå¯¹äºç”¨æˆ·ä¹‹é—´å…±äº«æ•°æ®çš„é™æ€è·¯ç”±ï¼Œæ•°æ®ä¼šåœ¨æ„å»ºæ—¶è·å–è€Œä¸æ˜¯åœ¨è¯·æ±‚æ—¶è·å–ã€‚ä½¿ç”¨ [Middleware](#optimistic-checks-with-middleware-optional)æ¥ä¿æŠ¤é™æ€è·¯ç”±ã€‚
> - å¯¹äºå®‰å…¨æ£€æŸ¥ï¼Œæ‚¨å¯ä»¥é€šè¿‡ä¸æ•°æ®åº“ä¸­çš„ä¼šè¯ ID è¿›è¡Œæ¯”è¾ƒæ¥éªŒè¯ä¼šè¯æ˜¯å¦æœ‰æ•ˆã€‚ä½¿ç”¨ React çš„[cache](https://react.dev/reference/react/cache)å‡½æ•°é¿å…åœ¨æ¸²æŸ“æœŸé—´å‘æ•°æ®åº“å‘å‡ºä¸å¿…è¦çš„é‡å¤è¯·æ±‚ã€‚
> - æ‚¨å¯ä»¥å°†ç›¸å…³çš„æ•°æ®è¯·æ±‚æ•´åˆåˆ° JavaScript ç±»ä¸­ï¼Œå¹¶åœ¨ä»»ä½•æ–¹æ³•ä¹‹å‰è¿è¡Œ`verifySession()`å‡½æ•°ã€‚

### ä½¿ç”¨æ•°æ®ä¼ è¾“å¯¹è±¡(DTO)

åœ¨æ£€ç´¢æ•°æ®æ—¶ï¼Œå»ºè®®æ‚¨åªè¿”å›å°†åœ¨åº”ç”¨ç¨‹åºä¸­ä½¿ç”¨çš„å¿…è¦æ•°æ®ï¼Œè€Œä¸æ˜¯æ•´ä¸ªå¯¹è±¡ã€‚ä¾‹å¦‚ï¼Œå¦‚æœæ‚¨æ­£åœ¨è·å–ç”¨æˆ·æ•°æ®ï¼Œæ‚¨å¯èƒ½åªè¿”å›ç”¨æˆ·çš„ ID å’Œå§“åï¼Œè€Œä¸æ˜¯åŒ…å«å¯†ç ã€ç”µè¯å·ç ç­‰çš„æ•´ä¸ªç”¨æˆ·å¯¹è±¡ã€‚

ä½†æ˜¯ï¼Œå¦‚æœæ‚¨æ— æ³•æ§åˆ¶è¿”å›çš„æ•°æ®ç»“æ„ï¼Œæˆ–è€…æ‚¨åœ¨ä¸€ä¸ªå›¢é˜Ÿä¸­å·¥ä½œå¹¶å¸Œæœ›é¿å…å°†æ•´ä¸ªå¯¹è±¡ä¼ é€’ç»™å®¢æˆ·ç«¯ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ç­–ç•¥æ¥æŒ‡å®šå“ªäº›å­—æ®µå¯ä»¥å®‰å…¨åœ°æš´éœ²ç»™å®¢æˆ·ç«¯ã€‚

```tsx filename="app/lib/dto.ts" switcher
import "server-only";
import { getUser } from "@/app/lib/dal";

function canSeeUsername(viewer: User) {
  return true;
}

function canSeePhoneNumber(viewer: User, team: string) {
  return viewer.isAdmin || team === viewer.team;
}

export async function getProfileDTO(slug: string) {
  const data = await db.query.users.findMany({
    where: eq(users.slug, slug),
    // Return specific columns here
  });
  const user = data[0];

  const currentUser = await getUser(user.id);

  // Or return only what's specific to the query here
  return {
    username: canSeeUsername(currentUser) ? user.username : null,
    phonenumber: canSeePhoneNumber(currentUser, user.team)
      ? user.phonenumber
      : null,
  };
}
```

```js filename="app/lib/dto.js" switcher
import "server-only";
import { getUser } from "@/app/lib/dal";

function canSeeUsername(viewer) {
  return true;
}

function canSeePhoneNumber(viewer, team) {
  return viewer.isAdmin || team === viewer.team;
}

export async function getProfileDTO(slug) {
  const data = await db.query.users.findMany({
    where: eq(users.slug, slug),
    // Return specific columns here
  });
  const user = data[0];

  const currentUser = await getUser(user.id);

  // Or return only what's specific to the query here
  return {
    username: canSeeUsername(currentUser) ? user.username : null,
    phonenumber: canSeePhoneNumber(currentUser, user.team)
      ? user.phonenumber
      : null,
  };
}
```

é€šè¿‡åœ¨ DAL ä¸­é›†ä¸­åŒ–æ‚¨çš„æ•°æ®è¯·æ±‚å’Œæˆæƒé€»è¾‘ï¼Œå¹¶ä½¿ç”¨ DTOï¼Œæ‚¨å¯ä»¥ç¡®ä¿æ‰€æœ‰æ•°æ®è¯·æ±‚éƒ½æ˜¯å®‰å…¨ä¸”ä¸€è‡´çš„ï¼Œä»è€Œä½¿æ‚¨çš„åº”ç”¨ç¨‹åºåœ¨æ‰©å±•æ—¶æ›´æ˜“äºç»´æŠ¤ã€å®¡æ ¸å’Œè°ƒè¯•ã€‚

> **æ‚¨éœ€è¦çŸ¥é“**:
>
> - æœ‰å‡ ç§ä¸åŒçš„æ–¹å¼å¯ä»¥å®šä¹‰ DTOï¼Œä¾‹å¦‚ä½¿ç”¨`toJSON()`ï¼Œæˆ–è€…åƒä¸Šé¢çš„ä¾‹å­é‚£æ ·ä½¿ç”¨å•ç‹¬çš„å‡½æ•°ï¼Œæˆ– JavaScript ç±»ã€‚ç”±äºè¿™äº›æ˜¯ JavaScript æ¨¡å¼ï¼Œè€Œä¸æ˜¯ React æˆ– Next.js çš„åŠŸèƒ½ï¼Œæˆ‘ä»¬å»ºè®®è¿›è¡Œä¸€äº›ç ”ç©¶ï¼Œä»¥æ‰¾åˆ°é€‚åˆæ‚¨åº”ç”¨ç¨‹åºçš„æœ€ä½³æ¨¡å¼ã€‚
> - äº†è§£æ›´å¤šå®‰å…¨æ€§æœ€ä½³å®è·µï¼Œè¯·å‚é˜…æˆ‘ä»¬çš„[Next.js å®‰å…¨æ€§æ–‡ç« ](/blog/security-nextjs-server-components-actions).

### Server Components

åœ¨[æœåŠ¡å™¨ç»„ä»¶](/docs/content/app/building-your-application/rendering/server-components) ä¸­è¿›è¡Œèº«ä»½éªŒè¯æ£€æŸ¥å¯¹äºåŸºäºè§’è‰²çš„è®¿é—®éå¸¸æœ‰ç”¨ã€‚ä¾‹å¦‚ï¼Œå¯ä»¥æ ¹æ®ç”¨æˆ·çš„è§’è‰²æœ‰æ¡ä»¶åœ°æ¸²æŸ“ç»„ä»¶ï¼š

```tsx filename="app/dashboard/page.tsx" switcher
import { verifySession } from "@/app/lib/dal";

export default function Dashboard() {
  const session = await verifySession();
  const userRole = session?.user?.role; // Assuming 'role' is part of the session object

  if (userRole === "admin") {
    return <AdminDashboard />;
  } else if (userRole === "user") {
    return <UserDashboard />;
  } else {
    redirect("/login");
  }
}
```

```jsx filename="app/dashboard/page.jsx" switcher
import { verifySession } from '@/app/lib/dal'

export default function Dashboard() {
  const session = await verifySession()
  const userRole = session.role // Assuming 'role' is part of the session object

  if (userRole === 'admin') {
    return <AdminDashboard />
  } else if (userRole === 'user') {
    return <UserDashboard />
  } else {
    redirect('/login')
  }
}
```

åœ¨æ­¤ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨ DAL ä¸­çš„ `verifySession()`å‡½æ•°æ¥æ£€æŸ¥ 'admin'ã€'user' å’Œæœªç»æˆæƒçš„è§’è‰²ã€‚æ­¤æ¨¡å¼ç¡®ä¿æ¯ä¸ªç”¨æˆ·åªä¸ä¸å…¶è§’è‰²ç›¸å¯¹åº”çš„ç»„ä»¶è¿›è¡Œäº¤äº’ã€‚

### å¸ƒå±€ä¸èº«ä»½éªŒè¯æ£€æŸ¥

ç”±äº[éƒ¨åˆ†æ¸²æŸ“](/docs/content/app/building-your-application/routing/linking-and-navigating#4-partial-rendering), åœ¨å¸ƒå±€ä¸­è¿›è¡Œæ£€æŸ¥æ—¶è¦è°¨æ…ï¼Œå› ä¸ºè¿™äº›å¸ƒå±€åœ¨å¯¼èˆªæ—¶ä¸ä¼šé‡æ–°æ¸²æŸ“ï¼Œè¿™æ„å‘³ç€ç”¨æˆ·ä¼šè¯ä¸ä¼šåœ¨æ¯æ¬¡è·¯ç”±æ›´æ”¹æ—¶è¿›è¡Œæ£€æŸ¥ã€‚

ç›¸åï¼Œæ‚¨åº”è¯¥åœ¨æ¥è¿‘æ•°æ®æºæˆ–å°†è¢«æœ‰æ¡ä»¶æ¸²æŸ“çš„ç»„ä»¶å¤„è¿›è¡Œæ£€æŸ¥ã€‚

ä¾‹å¦‚ï¼Œè€ƒè™‘ä¸€ä¸ªå…±äº«çš„å¸ƒå±€ï¼Œå®ƒè·å–ç”¨æˆ·æ•°æ®å¹¶åœ¨å¯¼èˆªä¸­æ˜¾ç¤ºç”¨æˆ·å›¾åƒã€‚æ‚¨ä¸åº”è¯¥åœ¨å¸ƒå±€ä¸­è¿›è¡Œèº«ä»½éªŒè¯æ£€æŸ¥ï¼Œè€Œåº”åœ¨å¸ƒå±€ä¸­è·å–ç”¨æˆ·æ•°æ® (`getUser()`)ï¼Œå¹¶åœ¨æ‚¨çš„ DAL ä¸­è¿›è¡Œèº«ä»½éªŒè¯æ£€æŸ¥ã€‚

è¿™å¯ä»¥ä¿è¯åœ¨åº”ç”¨ç¨‹åºä¸­çš„ä»»ä½•åœ°æ–¹è°ƒç”¨ getUser() æ—¶ï¼Œéƒ½ä¼šè¿›è¡Œèº«ä»½éªŒè¯æ£€æŸ¥ï¼Œå¹¶é˜²æ­¢å¼€å‘äººå‘˜å¿˜è®°æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰æƒè®¿é—®æ•°æ®ã€‚

```tsx filename="app/layout.tsx" switcher
export default async function Layout({
  children,
}: {
  children: React.ReactNode;
}) {
  const user = await getUser();

  return (
    // ...
  )
}
```

```jsx filename="app/layout.js" switcher
export default async function Layout({ children }) {
  const user = await getUser();

  return (
    // ...
  )
}
```

```ts filename="app/lib/dal.ts" switcher
export const getUser = cache(async () => {
  const session = await verifySession();
  if (!session) return null;

  // Get user ID from session and fetch data
});
```

```js filename="app/lib/dal.js" switcher
export const getUser = cache(async () => {
  const session = await verifySession();
  if (!session) return null;

  // Get user ID from session and fetch data
});
```

> **æ‚¨éœ€è¦çŸ¥é“:**
>
> - å•é¡µåº”ç”¨ç¨‹åº (SPA) çš„å¸¸è§æ¨¡å¼æ˜¯ï¼Œå¦‚æœç”¨æˆ·æœªæˆæƒï¼Œåˆ™åœ¨å¸ƒå±€æˆ–é¡¶çº§ç»„ä»¶ä¸­è¿”å› nullã€‚ç”±äº Next.js åº”ç”¨ç¨‹åºå…·æœ‰å¤šä¸ªå…¥å£ç‚¹ï¼Œæ­¤æ¨¡å¼ ä¸æ¨èï¼Œå› ä¸ºå®ƒæ— æ³•é˜²æ­¢åµŒå¥—è·¯ç”±æ®µå’ŒæœåŠ¡å™¨æ“ä½œè¢«è®¿é—®ã€‚

### Server Actions

å°†[æœåŠ¡å™¨æ“ä½œ](/docs/content/app/building-your-application/data-fetching/server-actions-and-mutations) è§†ä¸ºå…·æœ‰ä¸å…¬å¼€çš„ API ç«¯ç‚¹ç›¸åŒçš„å®‰å…¨è€ƒè™‘ï¼Œå¹¶éªŒè¯ç”¨æˆ·æ˜¯å¦æœ‰æƒé™æ‰§è¡Œå˜æ›´æ“ä½œã€‚

åœ¨ä¸‹é¢çš„ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬åœ¨å…è®¸æ“ä½œç»§ç»­è¿›è¡Œä¹‹å‰æ£€æŸ¥äº†ç”¨æˆ·çš„è§’è‰²ï¼š

```ts filename="app/lib/actions.ts" switcher
"use server";
import { verifySession } from "@/app/lib/dal";

export async function serverAction(formData: FormData) {
  const session = await verifySession();
  const userRole = session?.user?.role;

  // Return early if user is not authorized to perform the action
  if (userRole !== "admin") {
    return null;
  }

  // Proceed with the action for authorized users
}
```

```js filename="app/lib/actions.js" switcher
"use server";
import { verifySession } from "@/app/lib/dal";

export async function serverAction() {
  const session = await verifySession();
  const userRole = session.user.role;

  // Return early if user is not authorized to perform the action
  if (userRole !== "admin") {
    return null;
  }

  // Proceed with the action for authorized users
}
```

### Route Handlers

å°†[è·¯ç”±å¤„ç†ç¨‹åº](/docs/content/app/building-your-application/routing/route-handlers)è§†ä¸ºå…·æœ‰ä¸å…¬å¼€çš„ API ç«¯ç‚¹ç›¸åŒçš„å®‰å…¨è€ƒè™‘ï¼Œå¹¶éªŒè¯ç”¨æˆ·æ˜¯å¦æœ‰æƒé™è®¿é—®è·¯ç”±å¤„ç†ç¨‹åºã€‚

ä¾‹å¦‚

```ts filename="app/api/route.ts" switcher
import { verifySession } from "@/app/lib/dal";

export async function GET() {
  // User authentication and role verification
  const session = await verifySession();

  // Check if the user is authenticated
  if (!session) {
    // User is not authenticated
    return new Response(null, { status: 401 });
  }

  // Check if the user has the 'admin' role
  if (session.user.role !== "admin") {
    // User is authenticated but does not have the right permissions
    return new Response(null, { status: 403 });
  }

  // Continue for authorized users
}
```

```js filename="app/api/route.js" switcher
import { verifySession } from "@/app/lib/dal";

export async function GET() {
  // User authentication and role verification
  const session = await verifySession();

  // Check if the user is authenticated
  if (!session) {
    // User is not authenticated
    return new Response(null, { status: 401 });
  }

  // Check if the user has the 'admin' role
  if (session.user.role !== "admin") {
    // User is authenticated but does not have the right permissions
    return new Response(null, { status: 403 });
  }

  // Continue for authorized users
}
```

ä¸Šé¢çš„ç¤ºä¾‹å±•ç¤ºäº†ä¸€ä¸ªå¸¦æœ‰ä¸¤å±‚å®‰å…¨æ£€æŸ¥çš„è·¯ç”±å¤„ç†ç¨‹åºã€‚é¦–å…ˆæ£€æŸ¥æ˜¯å¦æœ‰æ´»åŠ¨çš„ä¼šè¯ï¼Œç„¶åéªŒè¯å·²ç™»å½•çš„ç”¨æˆ·æ˜¯å¦ä¸º 'admin'ã€‚

## Context Providers

ä½¿ç”¨ context providers è¿›è¡Œèº«ä»½éªŒè¯å·¥ä½œæ˜¯ç”±äº[interleaving](/docs/content/app/building-your-application/rendering/composition-patterns#interleaving-server-and-client-components)çš„åŸå› ã€‚ç„¶è€Œï¼ŒReact `context`åœ¨æœåŠ¡å™¨ç»„ä»¶ä¸­ä¸æ”¯æŒï¼Œå®ƒä»¬ä»…é€‚ç”¨äºå®¢æˆ·ç«¯ç»„ä»¶ã€‚

è¿™å¯ä»¥å·¥ä½œï¼Œä½†ä»»ä½•å­æœåŠ¡å™¨ç»„ä»¶éƒ½å°†é¦–å…ˆåœ¨æœåŠ¡å™¨ä¸Šæ¸²æŸ“ï¼Œä¸”æ— æ³•è®¿é—® context provider çš„ä¼šè¯æ•°æ®ï¼š

```tsx filename="app/layout.ts" switcher
import { ContextProvider } from "auth-lib";

export default function RootLayout({ children }) {
  return (
    <html lang="en">
      <body>
        <ContextProvider>{children}</ContextProvider>
      </body>
    </html>
  );
}
```

```tsx filename="app/ui/profile.ts switcher
"use client";

import { useSession } from "auth-lib";

export default function Profile() {
  const { userId } = useSession();
  const { data } = useSWR(`/api/user/${userId}`, fetcher)

  return (
    // ...
  );
}
```

```jsx filename="app/ui/profile.js switcher
"use client";

import { useSession } from "auth-lib";

export default function Profile() {
  const { userId } = useSession();
  const { data } = useSWR(`/api/user/${userId}`, fetcher)

  return (
    // ...
  );
}
```

å¦‚æœå®¢æˆ·ç«¯ç»„ä»¶éœ€è¦ä¼šè¯æ•°æ®ï¼ˆä¾‹å¦‚ï¼Œç”¨äºå®¢æˆ·ç«¯çš„æ•°æ®è·å–ï¼‰ï¼Œè¯·ä½¿ç”¨ React çš„ [`taintUniqueValue`](https://react.dev/reference/react/experimental_taintUniqueValue)APIï¼Œé˜²æ­¢æ•æ„Ÿçš„ä¼šè¯æ•°æ®æš´éœ²ç»™å®¢æˆ·ç«¯ã€‚

## Resources

ç°åœ¨æ‚¨å·²ç»äº†è§£äº† Next.js ä¸­çš„èº«ä»½éªŒè¯ï¼Œä»¥ä¸‹æ˜¯ä¸€äº›å…¼å®¹ Next.js çš„åº“å’Œèµ„æºï¼Œå¸®åŠ©æ‚¨å®ç°å®‰å…¨çš„èº«ä»½éªŒè¯å’Œä¼šè¯ç®¡ç†ï¼š

### èº«ä»½éªŒè¯åº“

- [Auth0](https://auth0.com/docs/quickstart/webapp/nextjs/01-login)
- [Clerk](https://clerk.com/docs/quickstarts/nextjs)
- [Kinde](https://kinde.com/docs/developer-tools/nextjs-sdk)
- [Lucia](https://lucia-auth.com/getting-started/nextjs-app)
- [NextAuth.js](https://authjs.dev/getting-started/installation?framework=next.js)
- [Stack Auth](https://docs.stack-auth.com/getting-started/setup)
- [Supabase](https://supabase.com/docs/guides/getting-started/quickstarts/nextjs)
- [Stytch](https://stytch.com/docs/guides/quickstarts/nextjs)
- [WorkOS](https://workos.com/docs/user-management)

### Session ç®¡ç†åº“

- [Iron Session](https://github.com/vvo/iron-session)
- [Jose](https://github.com/panva/jose)

## å»¶ä¼¸é˜…è¯»

ç»§ç»­å­¦ä¹ èº«ä»½éªŒè¯å’Œå®‰å…¨æ€§ï¼Œæ‚¨å¯ä»¥å‚è€ƒä»¥ä¸‹èµ„æºï¼š

- [å¦‚ä½•çœ‹å¾… Next.js ä¸­çš„å®‰å…¨æ€§](/blog/security-nextjs-server-components-actions)
- [äº†è§£ XSS æ”»å‡»](https://vercel.com/guides/understanding-xss-attacks)
- [äº†è§£ CSRF æ”»å‡»](https://vercel.com/guides/understanding-csrf-attacks)
- [Copenhagen Book](https://thecopenhagenbook.com/)
