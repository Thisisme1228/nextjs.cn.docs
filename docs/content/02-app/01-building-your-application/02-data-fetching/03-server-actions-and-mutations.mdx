---
title: æœåŠ¡å™¨æ“ä½œå’Œå˜æ›´
nav_title: Server Actions and Mutations
description: äº†è§£å¦‚ä½•ä½¿ç”¨Next.jså¤„ç†è¡¨å•æäº¤å’Œæ•°æ®å˜æ›´ã€‚
related:
  description: äº†è§£å¦‚ä½•åœ¨Next.jsä¸­é…ç½®æœåŠ¡å™¨æ“ä½œ
  links:
    - app/api-reference/next-config-js/serverActions
---

[æœåŠ¡å™¨æ“ä½œ](https://react.dev/reference/rsc/server-actions)æ˜¯åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œçš„ **å¼‚æ­¥å‡½æ•°**ã€‚å®ƒä»¬å¯ä»¥åœ¨æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯ç»„ä»¶ä¸­è°ƒç”¨ï¼Œæ¥å¤„ç† Next.js åº”ç”¨ç¨‹åºä¸­çš„è¡¨å•æäº¤å’Œæ•°æ®å˜æ›´ã€‚

> **ğŸ¥ è§‚çœ‹:** é€šè¿‡æœåŠ¡å™¨æ“ä½œäº†è§£å…³äºå˜æ›´çš„æ›´å¤šä¿¡æ¯ã€‚â†’ [YouTube (10 åˆ†é’Ÿ)](https://youtu.be/dDpZfOQBMaU?si=cJZHlUu_jFhCzHUg)ã€‚

## å…¬çº¦

å¯ä»¥ä½¿ç”¨ React [`"use server"`](https://react.dev/reference/react/use-server) æŒ‡ä»¤æ¥å®šä¹‰æœåŠ¡å™¨æ“ä½œã€‚æ‚¨å¯ä»¥å°†è¿™ä¸ªæŒ‡ä»¤æ”¾ç½®åœ¨`async`å‡½æ•°é¡¶éƒ¨æ¥å°†è¿™ä¸ªå‡½æ•°æ ‡è®°ä¸ºæœåŠ¡å™¨æ“ä½œï¼Œæˆ–è€…æ”¾åœ¨å•ä¸ªæ–‡ä»¶çš„é¡¶éƒ¨æ¥å°†è¯¥æ–‡ä»¶ä¸­çš„æ‰€æœ‰ export æ ‡è®°ä¸ºæœåŠ¡å™¨æ“ä½œã€‚

### æœåŠ¡å™¨ç»„ä»¶

æœåŠ¡å™¨ç»„ä»¶å¯ä»¥ä½¿ç”¨å†…è”å‡½æ•°çº§åˆ«æˆ–æ¨¡å—çº§åˆ«`"use server"`æŒ‡ä»¤ã€‚è¦å†…è”æœåŠ¡å™¨æ“ä½œï¼Œè¯·å°†`"use server"`æ·»åŠ åˆ°å‡½æ•°ä½“é¡¶éƒ¨ï¼š

```tsx filename="app/page.tsx" switcher
export default function Page() {
  // Server Action
  async function create() {
    "use server";
    // Mutate data
  }

  return "...";
}
```

```jsx filename="app/page.jsx" switcher
export default function Page() {
  // Server Action
  async function create() {
    "use server";
    // Mutate data
  }

  return "...";
}
```

### å®¢æˆ·ç«¯ç»„ä»¶

è¦åœ¨å®¢æˆ·ç«¯ç»„ä»¶ä¸­è°ƒç”¨æœåŠ¡å™¨ç»„ä»¶ï¼Œè¦åˆ›å»ºä¸€ä¸ªæ–‡ä»¶å¹¶å°† `"use server"`æŒ‡ä»¤æ·»åŠ åˆ°è¯¥æ–‡ä»¶ä¸Šæ–¹ã€‚è¯¥æ–‡ä»¶å†…çš„æ‰€æœ‰å‡½æ•°å°†ä¼šè¢«æ ‡è®°ä¸ºå¯ä»¥åœ¨å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ç»„ä»¶å†…é‡å¤ä½¿ç”¨çš„æœåŠ¡å™¨æ“ä½œï¼š

```tsx filename="app/actions.ts" switcher
"use server";

export async function create() {}
```

```js filename="app/actions.js" switcher
"use server";

export async function create() {}
```

```tsx filename="app/ui/button.tsx" switcher
"use client";

import { create } from "@/app/actions";

export function Button() {
  return <Button onClick={create} />;
}
```

```jsx filename="app/ui/button.js" switcher
"use client";

import { create } from "@/app/actions";

export function Button() {
  return <Button onClick={create} />;
}
```

### å°†æ“ä½œä½œä¸ºå±æ€§ä¼ é€’

æ‚¨ä¹Ÿå¯ä»¥å°†æœåŠ¡å™¨æ“ä½œä½œä¸ºå±æ€§ä¼ é€’ç»™å®¢æˆ·ç«¯ç»„ä»¶ï¼š

```jsx
<ClientComponent updateItemAction={updateItem} />
```

```tsx filename="app/client-component.tsx" switcher
"use client";

export default function ClientComponent({
  updateItemAction,
}: {
  updateItemAction: (formData: FormData) => void;
}) {
  return <form action={updateItemAction}>{/* ... */}</form>;
}
```

```jsx filename="app/client-component.jsx" switcher
"use client";

export default function ClientComponent({ updateItemAction }) {
  return <form action={updateItemAction}>{/* ... */}</form>;
}
```

é€šå¸¸ï¼ŒNext.js TypeScript æ’ä»¶ä¼šåœ¨`client-component.tsx`ä¸­ä¼šæ ‡è®°`updateItemAction`ï¼Œå› ä¸ºå®ƒæ˜¯ä¸€ä¸ªé€šå¸¸ä¸æ— æ³•è·¨å®¢æˆ·ç«¯-æœåŠ¡ç«¯è¾¹ç•Œåºåˆ—åŒ–çš„å‡½æ•°ã€‚
ä¸è¿‡ï¼Œä»¥`action`å‘½åæˆ–ä»¥`Action`ç»“å°¾ props è¢«å‡å®šä¸ºæ¥æ”¶æœåŠ¡å™¨æ“ä½œã€‚
è¿™åªæ˜¯ä¸€ä¸ªå¯å‘å› ä¸º TypeScript æ’ä»¶äº‹å®ä¸Šå¹¶ä¸çŸ¥é“å®ƒæ¥æ”¶çš„æ˜¯æœåŠ¡å™¨æ“ä½œè¿˜æ˜¯æ™®é€šå‡½æ•°ã€‚
è¿è¡Œæ—¶ç±»å‹æ£€æŸ¥å°†ä¼šä»ç„¶ç¡®ä¿æ‚¨ä¸ä¼šæ„å¤–å°†å‡½æ•°ä¼ é€’ç»™å®¢æˆ·ç«¯ç»„ä»¶ã€‚

## è¡Œä¸º

- å¯ä»¥ä½¿ç”¨[`<form>` å…ƒç´ ](#forms)ä¸­çš„`action`å±æ€§æ¥è°ƒç”¨æœåŠ¡å™¨æ“ä½œï¼š
  - é»˜è®¤æƒ…å†µä¸‹ï¼ŒæœåŠ¡å™¨ç»„ä»¶æ”¯æŒæ¸è¿›å¼å¢å¼º,è¿™æ„å‘³ç€å³ä½¿ Javascript å°šæœªè¢«åŠ è½½æˆ–è¢«ç¦ç”¨ï¼Œè¡¨å•ä»ç„¶ä¼šè¢«æäº¤ã€‚
  - åœ¨å®¢æˆ·ç«¯ç»„ä»¶ä¸­ï¼Œå¦‚æœ Javascript è¿˜æ²¡æœ‰è¢«åŠ è½½ï¼Œè°ƒç”¨æœåŠ¡å™¨æ“ä½œçš„è¡¨å•å°†ä¼šè¿›è¡Œæ’é˜Ÿæäº¤ formsï¼Œä¼˜å…ˆå¤„ç†å®¢æˆ·ç«¯æ¿€æ´»ã€‚
  - æ¿€æ´»å, æµè§ˆå™¨ä¸ä¼šåœ¨æäº¤è¡¨å•æ—¶è¿›è¡Œåˆ·æ–°ã€‚
- æœåŠ¡å™¨æ“ä½œä¸é™äº`<form>`æ“ä½œï¼Œä¹Ÿæ¶‰åŠæ—¶é—´å¤„ç†ç¨‹åºã€`useEffect`ã€ç¬¬ä¸‰æ–¹åº“å’Œå…¶å®ƒè¡¨å•å…ƒç´ ï¼Œå¦‚ï¼š`<button>`ã€‚
- æœåŠ¡å™¨æ“ä½œä¸ Next.js [ç¼“å­˜å’Œé‡æ–°éªŒè¯](/docs/content/app/building-your-application/caching) æ¶æ„é›†æˆã€‚è°ƒç”¨æ“ä½œæ—¶, Next.js èƒ½å¤Ÿåœ¨ä¸€æ¬¡æœåŠ¡å™¨å¾€è¿”ä¸­è¿”å›æ›´æ–°åçš„ UI å’Œæ–°æ•°æ®ã€‚
- åœ¨åå°, actions ä½¿ç”¨`POST` æ–¹æ³•, å¹¶ä¸”åªæœ‰ HTTP æ–¹æ³•å¯ä»¥è°ƒç”¨å®ƒä»¬ã€‚
- æœåŠ¡å™¨æ“ä½œçš„å‚æ•°å’Œè¿”å›å€¼å¿…é¡»å¯ç”± React åºåˆ—åŒ–. å‚é˜… React æ–‡æ¡£ä»¥è·å¾—[å¯åºåˆ—åŒ–çš„å‚æ•°å’Œå€¼](https://react.dev/reference/react/use-server#serializable-parameters-and-return-values)çš„åˆ—è¡¨ã€‚
- æœåŠ¡å™¨æ“ä½œæ˜¯å‡½æ•°ã€‚è¿™æ„å‘³ç€å®ƒä»¬å¯ä»¥åœ¨åº”ç”¨ç¨‹åºä¸­çš„ä»»ä½•åœ°æ–¹é‡å¤ä½¿ç”¨ã€‚
- æœåŠ¡å™¨æ“ä½œä»å…¶æ‰€ä½¿ç”¨çš„é¡µé¢æˆ–å¸ƒå±€ç»§æ‰¿[è¿è¡Œæ—¶](/docs/content/app/building-your-application/rendering/edge-and-nodejs-runtimes)ã€‚
- æœåŠ¡å™¨æ“ä½œä»å…¶æ‰€ä½¿ç”¨çš„é¡µé¢æˆ–å¸ƒå±€ç»§æ‰¿[è·¯ç”±æ®µé…ç½®](/docs/content/app/api-reference/file-conventions/route-segment-config)ï¼ŒåŒ…æ‹¬å­—æ®µï¼Œå¦‚`maxDuration`ã€‚

## ä¾‹å­

### Forms

React æ‰©å±• HTML [`<form>`](https://developer.mozilla.org/docs/Web/HTML/Element/form) å…ƒç´ ï¼Œä»¥ä¾¿å¯ä»¥ä½¿ç”¨`action` å±æ€§è°ƒç”¨æœåŠ¡å™¨æ“ä½œã€‚

å½“åœ¨è¡¨å•ä¸­è°ƒç”¨æ—¶, æ“ä½œè‡ªåŠ¨æ¥æ”¶[`FormData`](https://developer.mozilla.org/docs/Web/API/FormData/FormData) å¯¹è±¡ã€‚æ‚¨ä¸éœ€è¦ä½¿ç”¨ React `useState` æ¥ç®¡ç†å­—æ®µ, åè€Œ, æ‚¨å¯ä»¥ä½¿ç”¨åŸç”Ÿçš„[`FormData` æ–¹æ³•](https://developer.mozilla.org/en-US/docs/Web/API/FormData#instance_methods)æ¥æå–æ•°æ®ï¼š

```tsx filename="app/invoices/page.tsx" switcher
export default function Page() {
  async function createInvoice(formData: FormData) {
    "use server";

    const rawFormData = {
      customerId: formData.get("customerId"),
      amount: formData.get("amount"),
      status: formData.get("status"),
    };

    // mutate data
    // revalidate cache
  }

  return <form action={createInvoice}>...</form>;
}
```

```jsx filename="app/invoices/page.jsx" switcher
export default function Page() {
  async function createInvoice(formData) {
    "use server";

    const rawFormData = {
      customerId: formData.get("customerId"),
      amount: formData.get("amount"),
      status: formData.get("status"),
    };

    // mutate data
    // revalidate cache
  }

  return <form action={createInvoice}>...</form>;
}
```

> **æ‚¨éœ€è¦çŸ¥é“:**
>
> - ç¤ºä¾‹: [å¸¦æœ‰åŠ è½½å’Œé”™è¯¯çŠ¶æ€çš„è¡¨å•](https://github.com/vercel/next.js/tree/canary/examples/next-forms)
> - å½“å¤„ç†åŒ…å«è®¸å¤šå­—æ®µçš„è¡¨å•æ—¶ï¼Œæ‚¨å¯ä»¥è€ƒè™‘ä½¿ç”¨å¸¦æœ‰ JavaScript [`Object.fromEntries()`](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object/fromEntries) çš„[`entries()`](https://developer.mozilla.org/en-US/docs/Web/API/FormData/entries) æ–¹æ³•ã€‚ ä¾‹å¦‚: `const rawFormData = Object.fromEntries(formData)`ã€‚éœ€è¦æ³¨æ„çš„ä¸€ç‚¹æ˜¯`formData`åŒ…å«é™„åŠ çš„`$ACTION_`å±æ€§ã€‚
> - å‚é˜… [React `<form>` æ–‡æ¡£](https://react.dev/reference/react-dom/components/form#handle-form-submission-with-a-server-action)äº†è§£æ›´å¤šä¿¡æ¯ã€‚

### ä¼ é€’é™„åŠ å‚æ•°

æ‚¨å¯ä»¥ä½¿ç”¨ JavaScript `bind`æ–¹æ³•å‘æœåŠ¡å™¨æ“ä½œä¼ é€’å…¶å®ƒçš„å‚æ•°ã€‚

```tsx filename="app/client-component.tsx" highlight={6} switcher
"use client";

import { updateUser } from "./actions";

export function UserProfile({ userId }: { userId: string }) {
  const updateUserWithId = updateUser.bind(null, userId);

  return (
    <form action={updateUserWithId}>
      <input type="text" name="name" />
      <button type="submit">Update User Name</button>
    </form>
  );
}
```

```jsx filename="app/client-component.js" highlight={6} switcher
"use client";

import { updateUser } from "./actions";

export function UserProfile({ userId }) {
  const updateUserWithId = updateUser.bind(null, userId);

  return (
    <form action={updateUserWithId}>
      <input type="text" name="name" />
      <button type="submit">Update User Name</button>
    </form>
  );
}
```

é™¤äº†è¡¨å•æ•°æ®ï¼ŒæœåŠ¡å™¨æ“ä½œä¼šæ”¶åˆ°`userId`å‚æ•°:

```js filename="app/actions.js"
"use server";

export async function updateUser(userId, formData) {}
```

> **æ‚¨éœ€è¦çŸ¥é“**:
>
> - å¦ä¸€ç§æ–¹æ³•æ˜¯å°†å‚æ•°ä½œä¸ºè¡¨å•ä¸­éšè—çš„ input å­—æ®µè¿›è¡Œä¼ é€’ (ä¾‹å¦‚ `<input type="hidden" name="userId" value={userId} />`)ã€‚ä¸è¿‡, è¯¥å€¼å°†ä¼šæˆä¸ºæ¸²æŸ“ HTML çš„ä¸€éƒ¨åˆ†ï¼Œå¹¶ä¸”ä¸ä¼šè¢«ç¼–ç ã€‚
> - `.bind`é€‚ç”¨äºæœåŠ¡å™¨å’Œå®¢æˆ·ç«¯ç»„ä»¶ã€‚å®ƒä¹Ÿæ”¯æŒæ¸è¿›å¢å¼ºã€‚

### åµŒå¥—è¡¨å•å…ƒç´ 

æ‚¨ä¹Ÿå¯ä»¥åœ¨åµŒå¥—åœ¨`<form>`å†…çš„å…ƒç´ ä¸­è°ƒç”¨æœåŠ¡å™¨æ“ä½œï¼Œå¦‚`<button>`ã€ `<input type="submit">`å’Œ `<input type="image">`ã€‚è¿™äº›å…ƒç´ æ¥æ”¶`formAction`å±æ€§æˆ–è€…[äº‹ä»¶å¤„ç†ç¨‹åº](#event-handlers)ã€‚

è¿™åœ¨æ‚¨æƒ³åœ¨ä¸€ä¸ªè¡¨å•ä¸­è°ƒç”¨å¤šä¸ªæœåŠ¡å™¨æ“ä½œæ—¶éå¸¸æœ‰ç”¨ã€‚ä¾‹å¦‚ï¼Œé™¤äº†å‘å¸ƒå¸–å­è‰ç¨¿ï¼Œæ‚¨å¯ä»¥åˆ›å»ºä¸€ä¸ªç‰¹å®šçš„`<button>`å…ƒç´ æ¥ä¿å­˜å¸–å­è‰ç¨¿ã€‚å‚é˜…[React `<form>` æ–‡æ¡£](https://react.dev/reference/react-dom/components/form#handling-multiple-submission-types)æ¥è·å¾—æ›´å¤šä¿¡æ¯ã€‚

### ç¼–ç¨‹å¼è¡¨å•æäº¤

æ‚¨å¯ä»¥ä½¿ç”¨[`requestSubmit()`](https://developer.mozilla.org/en-US/docs/Web/API/HTMLFormElement/requestSubmit)æ–¹æ³•æ¥ä»¥ç¼–ç¨‹å¼è§¦å‘è¡¨å•æäº¤ã€‚ä¾‹å¦‚ï¼Œå½“ç”¨æˆ·ä½¿ç”¨`âŒ˜` + `Enter`å¿«æ·é”®æäº¤è¡¨å•ï¼Œæ‚¨å¯ä»¥ç›‘å¬`onKeyDown`äº‹ä»¶ï¼š

```tsx filename="app/entry.tsx" switcher
"use client";

export function Entry() {
  const handleKeyDown = (e: React.KeyboardEvent<HTMLTextAreaElement>) => {
    if (
      (e.ctrlKey || e.metaKey) &&
      (e.key === "Enter" || e.key === "NumpadEnter")
    ) {
      e.preventDefault();
      e.currentTarget.form?.requestSubmit();
    }
  };

  return (
    <div>
      <textarea name="entry" rows={20} required onKeyDown={handleKeyDown} />
    </div>
  );
}
```

```jsx filename="app/entry.jsx" switcher
"use client";

export function Entry() {
  const handleKeyDown = (e) => {
    if (
      (e.ctrlKey || e.metaKey) &&
      (e.key === "Enter" || e.key === "NumpadEnter")
    ) {
      e.preventDefault();
      e.currentTarget.form?.requestSubmit();
    }
  };

  return (
    <div>
      <textarea name="entry" rows={20} required onKeyDown={handleKeyDown} />
    </div>
  );
}
```

è¿™å°†ä¼šè§¦å‘æœ€è¿‘çš„`<form>`åŸå‹æäº¤ï¼Œä»è€Œè°ƒç”¨æœåŠ¡å™¨æ“ä½œã€‚

### æœåŠ¡å™¨ç«¯è¡¨å•éªŒè¯

å¯¹äºåŸºæœ¬çš„å®¢æˆ·ç«¯è¡¨å•éªŒè¯ï¼Œæˆ‘ä»¬æ¨èä½¿ç”¨åƒ `required` å’Œ `type="email"`è¿›è¡Œ HTML éªŒè¯ã€‚

å¯¹äºæ›´é«˜çº§çš„æœåŠ¡å™¨ç«¯éªŒè¯, åœ¨æ›´æ”¹æ•°æ®ä¹‹å‰æ‚¨å¯ä»¥ä½¿ç”¨åº“ï¼ˆå¦‚ï¼š[zod](https://zod.dev/)ï¼‰éªŒè¯è¡¨å•å­—æ®µï¼š

```tsx filename="app/actions.ts" switcher
"use server";

import { z } from "zod";

const schema = z.object({
  email: z.string({
    invalid_type_error: "Invalid Email",
  }),
});

export default async function createUser(formData: FormData) {
  const validatedFields = schema.safeParse({
    email: formData.get("email"),
  });

  // Return early if the form data is invalid
  if (!validatedFields.success) {
    return {
      errors: validatedFields.error.flatten().fieldErrors,
    };
  }

  // Mutate data
}
```

```jsx filename="app/actions.js" switcher
"use server";

import { z } from "zod";

const schema = z.object({
  email: z.string({
    invalid_type_error: "Invalid Email",
  }),
});

export default async function createsUser(formData) {
  const validatedFields = schema.safeParse({
    email: formData.get("email"),
  });

  // Return early if the form data is invalid
  if (!validatedFields.success) {
    return {
      errors: validatedFields.error.flatten().fieldErrors,
    };
  }

  // Mutate data
}
```

ä¸€æ—¦æœåŠ¡å™¨ä¸ŠéªŒè¯äº†å­—æ®µï¼Œæ‚¨å¯ä»¥åœ¨æ“ä½œä¸­è¿”å›ä¸€ä¸ªå¯åºåˆ—åŒ–çš„å¯¹è±¡å¹¶ä½¿ç”¨ React [`useActionState`](https://react.dev/reference/react/useActionState) hook å‘ç”¨æˆ·å±•ç¤º messageã€‚

- é€šè¿‡å‘`useActionState`ä¼ é€’æ“ä½œ, è¯¥æ“ä½œçš„å‡½æ•°ç­¾åä¼šå‘ç”Ÿå˜åŒ–æ¥æ¥æ”¶ä¸€ä¸ªæ–°çš„`prevState` æˆ– `initialState`å‚æ•°ä½œä¸ºå…¶ç¬¬ä¸€ä¸ªå‚æ•°ã€‚
- `useActionState` æ˜¯ä¸€ä¸ª React hookï¼Œå› æ­¤å¿…é¡»åœ¨å®¢æˆ·ç«¯ç»„ä»¶ä¸­ä½¿ç”¨ã€‚

```tsx filename="app/actions.ts" switcher
"use server";

import { redirect } from "next/navigation";

export async function createUser(prevState: any, formData: FormData) {
  const res = await fetch("https://...");
  const json = await res.json();

  if (!res.ok) {
    return { message: "Please enter a valid email" };
  }

  redirect("/dashboard");
}
```

```jsx filename="app/actions.js" switcher
"use server";

import { redirect } from "next/navigation";

export async function createUser(prevState, formData) {
  const res = await fetch("https://...");
  const json = await res.json();

  if (!res.ok) {
    return { message: "Please enter a valid email" };
  }

  redirect("/dashboard");
}
```

ç„¶å, æ‚¨èƒ½å¤Ÿå‘`useActionState` hook ä¼ é€’æ“ä½œå¹¶ä½¿ç”¨è¿”å›çš„`state`æ¥å±•ç¤ºé”™è¯¯æ¶ˆæ¯ã€‚

```tsx filename="app/ui/signup.tsx" highlight={11,18-20} switcher
"use client";

import { useActionState } from "react";
import { createUser } from "@/app/actions";

const initialState = {
  message: "",
};

export function Signup() {
  const [state, formAction] = useActionState(createUser, initialState);

  return (
    <form action={formAction}>
      <label htmlFor="email">Email</label>
      <input type="text" id="email" name="email" required />
      {/* ... */}
      <p aria-live="polite">{state?.message}</p>
      <button>Sign up</button>
    </form>
  );
}
```

```jsx filename="app/ui/signup.js" highlight={11,18-20} switcher
"use client";

import { useActionState } from "react";
import { createUser } from "@/app/actions";

const initialState = {
  message: "",
};

export function Signup() {
  const [state, formAction] = useActionState(createUser, initialState);

  return (
    <form action={formAction}>
      <label htmlFor="email">Email</label>
      <input type="text" id="email" name="email" required />
      {/* ... */}
      <p aria-live="polite">{state?.message}</p>
      <button>Sign up</button>
    </form>
  );
}
```

> **æ‚¨éœ€è¦çŸ¥é“:**
>
> - åœ¨æ”¹å˜æ•°æ®ä¹‹å‰,æ‚¨åº”è¯¥å§‹ç»ˆç¡®ä¿ç”¨æˆ·ä¹Ÿæœ‰æƒæ‰§è¡Œæ­¤æ“ä½œã€‚å‚é˜…[éªŒè¯å’Œæˆæƒ](#authentication-and-authorization).
> - åœ¨æ—©èµ·çš„ React Canary ç‰ˆæœ¬ä¸­, è¯¥ API æ˜¯ React DOM çš„ä¸€éƒ¨åˆ†ï¼Œè¢«ç§°ä¸º`useFormState`ã€‚

### å¾…å®šçŠ¶æ€

[`useActionState`](https://react.dev/reference/react/useActionState) hook æš´éœ²äº†`pending`çŠ¶æ€ï¼Œå¯ç”¨äºæ‰§è¡Œæ“ä½œæ—¶æ˜¾ç¤ºåŠ è½½æŒ‡ç¤ºå™¨ã€‚

```tsx filename="app/submit-button.tsx" highlight={11,21-23} switcher
"use client";

import { useActionState } from "react";
import { createUser } from "@/app/actions";

const initialState = {
  message: "",
};

export function Signup() {
  const [state, formAction, pending] = useActionState(createUser, initialState);

  return (
    <form action={formAction}>
      <label htmlFor="email">Email</label>
      <input type="text" id="email" name="email" required />
      {/* ... */}
      <p aria-live="polite" className="sr-only">
        {state?.message}
      </p>
      <button aria-disabled={pending} type="submit">
        {pending ? "Submitting..." : "Sign up"}
      </button>
    </form>
  );
}
```

```jsx filename="app/submit-button.jsx" highlight={11,21-23} switcher
"use client";

import { useActionState } from "react";
import { createUser } from "@/app/actions";

const initialState = {
  message: "",
};

export function Signup() {
  const [state, formAction, pending] = useActionState(createUser, initialState);

  return (
    <form action={formAction}>
      <label htmlFor="email">Email</label>
      <input type="text" id="email" name="email" required />
      {/* ... */}
      <p aria-live="polite" className="sr-only">
        {state?.message}
      </p>
      <button aria-disabled={pending} type="submit">
        {pending ? "Submitting..." : "Sign up"}
      </button>
    </form>
  );
}
```

> **æ‚¨éœ€è¦çŸ¥é“:** æˆ–è€…, æ‚¨ä¹Ÿå¯ä»¥ä½¿ç”¨[`useFormStatus`](https://react.dev/reference/react-dom/hooks/useFormStatus) hook ä¸ºç‰¹å®šè¡¨å•æ˜¾ç¤º pending çŠ¶æ€ã€‚

### Optimistic updates

æ‚¨å¯ä»¥åœ¨æœåŠ¡å™¨æ“ä½œå®Œæˆæ‰§è¡Œä¹‹å‰ä½¿ç”¨ React [`useOptimistic`](https://react.dev/reference/react/useOptimistic) hook æ¥ä¹è§‚åœ°æ›´æ–° UI, è€Œä¸æ˜¯ç­‰å¾…å“åº”ï¼š

```tsx filename="app/page.tsx" switcher
"use client";

import { useOptimistic } from "react";
import { send } from "./actions";

type Message = {
  message: string;
};

export function Thread({ messages }: { messages: Message[] }) {
  const [optimisticMessages, addOptimisticMessage] = useOptimistic<
    Message[],
    string
  >(messages, (state, newMessage) => [...state, { message: newMessage }]);

  const formAction = async (formData) => {
    const message = formData.get("message") as string;
    addOptimisticMessage(message);
    await send(message);
  };

  return (
    <div>
      {optimisticMessages.map((m, i) => (
        <div key={i}>{m.message}</div>
      ))}
      <form action={formAction}>
        <input type="text" name="message" />
        <button type="submit">Send</button>
      </form>
    </div>
  );
}
```

```jsx filename="app/page.jsx" switcher
"use client";

import { useOptimistic } from "react";
import { send } from "./actions";

export function Thread({ messages }) {
  const [optimisticMessages, addOptimisticMessage] = useOptimistic(
    messages,
    (state, newMessage) => [...state, { message: newMessage }]
  );

  const formAction = async (formData) => {
    const message = formData.get("message");
    addOptimisticMessage(message);
    await send(message);
  };

  return (
    <div>
      {optimisticMessages.map((m) => (
        <div>{m.message}</div>
      ))}
      <form action={formAction}>
        <input type="text" name="message" />
        <button type="submit">Send</button>
      </form>
    </div>
  );
}
```

### äº‹ä»¶å¤„ç†ç¨‹åº

å°½ç®¡åœ¨`<form>`å…ƒç´ å†…ä½¿ç”¨æœåŠ¡å™¨æ“ä½œå¾ˆå¸¸è§ï¼Œä½†ä¹Ÿå¯ä»¥ä½¿ç”¨äº‹ä»¶å¤„ç†ç¨‹åºæ¥è°ƒç”¨å®ƒä»¬ï¼ˆå¦‚ï¼š`onClick`ï¼‰ã€‚ä¾‹å¦‚ï¼Œè¦å¢åŠ ç‚¹èµæ•°é‡ï¼š

```tsx filename="app/like-button.tsx" switcher
"use client";

import { incrementLike } from "./actions";
import { useState } from "react";

export default function LikeButton({ initialLikes }: { initialLikes: number }) {
  const [likes, setLikes] = useState(initialLikes);

  return (
    <>
      <p>Total Likes: {likes}</p>
      <button
        onClick={async () => {
          const updatedLikes = await incrementLike();
          setLikes(updatedLikes);
        }}
      >
        Like
      </button>
    </>
  );
}
```

```jsx filename="app/like-button.js" switcher
"use client";

import { incrementLike } from "./actions";
import { useState } from "react";

export default function LikeButton({ initialLikes }) {
  const [likes, setLikes] = useState(initialLikes);

  return (
    <>
      <p>Total Likes: {likes}</p>
      <button
        onClick={async () => {
          const updatedLikes = await incrementLike();
          setLikes(updatedLikes);
        }}
      >
        Like
      </button>
    </>
  );
}
```

æ‚¨ä¹Ÿå¯ä»¥å‘è¡¨å•å…ƒç´ æ·»åŠ äº‹ä»¶å¤„ç†ç¨‹åºï¼Œä¾‹å¦‚ï¼Œä¿å­˜ä¸€ä¸ªè¡¨å•å­—æ®µ' onChange 'ï¼š

```tsx filename="app/ui/edit-post.tsx"
"use client";

import { publishPost, saveDraft } from "./actions";

export default function EditPost() {
  return (
    <form action={publishPost}>
      <textarea
        name="content"
        onChange={async (e) => {
          await saveDraft(e.target.value);
        }}
      />
      <button type="submit">Publish</button>
    </form>
  );
}
```

å¯¹äºè¿™ç§å¯èƒ½å¿«é€Ÿè¿ç»­è§¦å‘å¤šä¸ªäº‹ä»¶çš„æƒ…å†µï¼Œæˆ‘ä»¬æ¨è**æ¶ˆé™¤æŠ–åŠ¨**æ¥é˜²æ­¢ä¸å¿…è¦çš„æœåŠ¡å™¨æ“ä½œè°ƒç”¨ã€‚

### `useEffect`

å½“ç»„ä»¶æŒ‚è½½æˆ–ä¾èµ–å‘ç”Ÿå˜åŒ–æ—¶ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ React [`useEffect`](https://react.dev/reference/react/useEffect) hook æ¥è°ƒç”¨æœåŠ¡å™¨æ“ä½œã€‚è¿™å¯¹äºä¾èµ–äºå…¨å±€äº‹ä»¶æˆ–éœ€è¦è¢«è‡ªåŠ¨è§¦å‘çš„ mutations éå¸¸æœ‰ç”¨ã€‚ä¾‹å¦‚ï¼Œapp å¿«æ·é”®`onKeyDown`ã€ç”¨äºæ— é™æ»šåŠ¨çš„äº¤å‰è§‚å¯Ÿå™¨é’©å­æˆ–å½“ç»„ä»¶æŒ‚è½½ä»¥æ›´æ–°è§†å›¾è®¡æ•°æ—¶:

```tsx filename="app/view-count.tsx" switcher
"use client";

import { incrementViews } from "./actions";
import { useState, useEffect } from "react";

export default function ViewCount({ initialViews }: { initialViews: number }) {
  const [views, setViews] = useState(initialViews);

  useEffect(() => {
    const updateViews = async () => {
      const updatedViews = await incrementViews();
      setViews(updatedViews);
    };

    updateViews();
  }, []);

  return <p>Total Views: {views}</p>;
}
```

```jsx filename="app/view-count.js" switcher
"use client";

import { incrementViews } from "./actions";
import { useState, useEffect } from "react";

export default function ViewCount({ initialViews }: { initialViews: number }) {
  const [views, setViews] = useState(initialViews);

  useEffect(() => {
    const updateViews = async () => {
      const updatedViews = await incrementViews();
      setViews(updatedViews);
    };

    updateViews();
  }, []);

  return <p>Total Views: {views}</p>;
}
```

è®°ä½äº†è§£`useEffect`çš„[è¡Œä¸ºå’Œæ³¨æ„äº‹é¡¹](https://react.dev/reference/react/useEffect#caveats)ã€‚

### é”™è¯¯å¤„ç†

å½“æŠ›å‡ºé”™è¯¯æ—¶, å®ƒå°†ä¼šè¢«å®¢æˆ·ç«¯ä¸Šæœ€è¿‘çš„[`error.js`](/docs/content/app/building-your-application/routing/error-handling) æˆ– `<Suspense>` è¾¹ç•Œæ•è·ã€‚æˆ‘ä»¬æ¨èä½¿ç”¨`try/catch`è¿”å›ç”± UI å¤„ç†çš„é”™è¯¯ã€‚

ä¾‹å¦‚, æ‚¨çš„æœåŠ¡å™¨æ“ä½œå¯ä»¥é€šè¿‡è¿”å›ä¸€æ¡æ¶ˆæ¯æ¥å¤„ç†åˆ›å»ºæ–°é¡¹æ—¶å‡ºç°çš„é”™è¯¯ï¼š

```ts filename="app/actions.ts" switcher
"use server";

export async function createTodo(prevState: any, formData: FormData) {
  try {
    // Mutate data
  } catch (e) {
    throw new Error("Failed to create task");
  }
}
```

```js filename="app/actions.js" switcher
"use server";

export async function createTodo(prevState, formData) {
  try {
    //  Mutate data
  } catch (e) {
    throw new Error("Failed to create task");
  }
}
```

> **æ‚¨éœ€è¦çŸ¥é“:**
>
> - é™¤äº†æŠ›å‡ºé”™è¯¯, æ‚¨ä¹Ÿå¯ä»¥è¿”å›ä¸€ä¸ªç”±`useActionState`å¤„ç†çš„å¯¹è±¡ã€‚å‚é˜… [æœåŠ¡å™¨ç«¯éªŒè¯å’Œé”™è¯¯å¤„ç†](#server-side-form-validation).

### é‡æ–°éªŒè¯æ•°æ®

æ‚¨å¯ä»¥åœ¨æœåŠ¡å™¨æ“ä½œä¸­ä½¿ç”¨[`revalidatePath`](/docs/content/app/api-reference/functions/revalidatePath) API é‡æ–°éªŒè¯[Next.js ç¼“å­˜](/docs/content/app/building-your-application/caching):

```ts filename="app/actions.ts" switcher
"use server";

import { revalidatePath } from "next/cache";

export async function createPost() {
  try {
    // ...
  } catch (error) {
    // ...
  }

  revalidatePath("/posts");
}
```

```js filename="app/actions.js" switcher
"use server";

import { revalidatePath } from "next/cache";

export async function createPost() {
  try {
    // ...
  } catch (error) {
    // ...
  }

  revalidatePath("/posts");
}
```

æˆ–ä½¿ç”¨[`revalidateTag`](/docs/content/app/api-reference/functions/revalidateTag)æ¥ä½¿å¸¦æœ‰ç¼“å­˜æ ‡ç­¾çš„ç‰¹å®šæ•°æ®è·å–æ— æ•ˆï¼š

```ts filename="app/actions.ts" switcher
"use server";

import { revalidateTag } from "next/cache";

export async function createPost() {
  try {
    // ...
  } catch (error) {
    // ...
  }

  revalidateTag("posts");
}
```

```js filename="app/actions.js" switcher
"use server";

import { revalidateTag } from "next/cache";

export async function createPost() {
  try {
    // ...
  } catch (error) {
    // ...
  }

  revalidateTag("posts");
}
```

### é‡å®šå‘

å¦‚æœæ‚¨æƒ³åœ¨æœåŠ¡å™¨æ“ä½œå®Œæˆåå°†ç”¨æˆ·é‡å®šå‘åˆ°ä¸åŒçš„è·¯ç”±, æ‚¨å¯ä»¥ä½¿ç”¨[`redirect`](/docs/content/app/api-reference/functions/redirect) API. `redirect` éœ€è¦åœ¨`try/catch`å—å¤–è°ƒç”¨:

```ts filename="app/actions.ts" switcher
"use server";

import { redirect } from "next/navigation";
import { revalidateTag } from "next/cache";

export async function createPost(id: string) {
  try {
    // ...
  } catch (error) {
    // ...
  }

  revalidateTag("posts"); // Update cached posts
  redirect(`/post/${id}`); // Navigate to the new post page
}
```

```js filename="app/actions.js" switcher
"use server";

import { redirect } from "next/navigation";
import { revalidateTag } from "next/cache";

export async function createPost(id) {
  try {
    // ...
  } catch (error) {
    // ...
  }

  revalidateTag("posts"); // Update cached posts
  redirect(`/post/${id}`); // Navigate to the new post page
}
```

### Cookies

æ‚¨å¯ä»¥åœ¨æœåŠ¡å™¨æ“ä½œä¸­ä½¿ç”¨[`cookies`](/docs/content/app/api-reference/functions/cookies) API æ¥`get`ã€ `set`å’Œ`delete` cookies:

```ts filename="app/actions.ts" switcher
"use server";

import { cookies } from "next/headers";

export async function exampleAction() {
  // Get cookie
  const value = cookies().get("name")?.value;

  // Set cookie
  cookies().set("name", "Delba");

  // Delete cookie
  cookies().delete("name");
}
```

```js filename="app/actions.js" switcher
"use server";

import { cookies } from "next/headers";

export async function exampleAction() {
  // Get cookie
  const value = cookies().get("name")?.value;

  // Set cookie
  cookies().set("name", "Delba");

  // Delete cookie
  cookies().delete("name");
}
```

å‚é˜…ä»æœåŠ¡å™¨æ“ä½œä¸­åˆ é™¤ cookies çš„ [å…¶å®ƒç¤ºä¾‹](/docs/content/app/api-reference/functions/cookies#deleting-cookies) ã€‚

## Security

### èº«ä»½éªŒè¯å’Œæˆæƒ

æ‚¨åº”è¯¥å°†æœåŠ¡å™¨æ“ä½œè§†ä¸ºé¢å‘å…¬ä¼—çš„ API ç«¯ç‚¹, å¹¶ç¡®ä¿ç”¨æˆ·æœ‰æƒæ‰§è¡Œæ“ä½œã€‚ä¾‹å¦‚ï¼š

```tsx filename="app/actions.ts"
"use server";

import { auth } from "./lib";

export function addItem() {
  const { user } = auth();
  if (!user) {
    throw new Error("You must be signed in to perform this action");
  }

  // ...
}
```

### é—­åŒ…å’ŒåŠ å¯†

åœ¨ç»„ä»¶ä¸­å®šä¹‰æœåŠ¡å™¨æ“ä½œä¼šåˆ›å»ºä¸€ä¸ª[é—­åŒ…](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Closures)ï¼Œæ“ä½œå¯ä»¥è®¿é—®å¤–éƒ¨å‡½æ•°çš„ä½œç”¨åŸŸã€‚ä¾‹å¦‚ï¼Œ`publish` æ“ä½œå¯ä»¥è®¿é—®`publishVersion`å˜é‡ï¼š

```tsx filename="app/page.tsx" switcher
export default async function Page() {
  const publishVersion = await getLatestVersion();

  async function publish() {
    "use server";
    if (publishVersion !== await getLatestVersion()) {
      throw new Error('The version has changed since pressing publish');
    }
    ...
  }

  return (
    <form>
      <button formAction={publish}>Publish</button>
    </form>
  );
}
```

```jsx filename="app/page.js" switcher
export default async function Page() {
  const publishVersion = await getLatestVersion();

  async function publish() {
    "use server";
    if (publishVersion !== await getLatestVersion()) {
      throw new Error('The version has changed since pressing publish');
    }
    ...
  }

  return (
    <form>
      <button formAction={publish}>Publish</button>
    </form>
  );
}
```

å½“æ‚¨éœ€è¦åœ¨æ¸²æŸ“æ—¶æ•è·æ•°æ®å¿«ç…§(ä¾‹å¦‚ï¼š`publishVersion`)ä»¥ä¾¿å®ƒèƒ½å¤Ÿåœ¨ç¨åè°ƒç”¨æ“ä½œæ—¶ä½¿ç”¨ï¼Œé—­åŒ…éå¸¸æœ‰ç”¨ã€‚

ä¸è¿‡ï¼Œä¸ºäº†å®ç°è¿™ä¸€ç‚¹ï¼Œæ•è·çš„å˜é‡ä¼šåœ¨è°ƒç”¨æ“ä½œæ—¶è¢«å‘é€åˆ°å®¢æˆ·ç«¯å¹¶è¿”å›åˆ°æœåŠ¡å™¨ã€‚ä¸ºäº†é˜²æ­¢å°†æ•æ„Ÿæ•°æ®æš´éœ²åˆ°å®¢æˆ·ç«¯ï¼ŒNext.js è‡ªåŠ¨åŠ å¯†å°é—­å˜é‡ã€‚æ¯æ¬¡æ„å»º Next.js åº”ç”¨ç¨‹åºæ—¶ï¼Œä¼šä¸ºæ¯ä¸ªæ“ä½œç”Ÿæˆä¸€ä¸ªç§˜å¯†å¯†é’¥ã€‚è¿™æ„å‘³ç€åªèƒ½ä¸ºæŒ‡å®šçš„ build è°ƒç”¨æ“ä½œã€‚

> **æ‚¨éœ€è¦çŸ¥é“:** æˆ‘ä»¬ä¸æ¨èä»…ä¾èµ–åŠ å¯†æ¥é¢„é˜²å°†æ•æ„Ÿå€¼æš´éœ²åˆ°å®¢æˆ·ç«¯ã€‚ç›¸åï¼Œæ‚¨åº”è¯¥ä½¿ç”¨[React taint APIs](/docs/content/app/building-your-application/data-fetching/fetching#preventing-sensitive-data-from-being-exposed-to-the-client)æ¥ä¸»åŠ¨é˜»æ­¢ç‰¹å®šæ•°æ®å‘é€åˆ°å®¢æˆ·ç«¯ã€‚

### é‡å†™åŠ å¯†ç§˜é’¥ (é«˜çº§)

è·¨å¤šä¸ªæœåŠ¡å™¨è‡ªæ‰˜ç®¡ Next.js åº”ç”¨ç¨‹åºæ—¶ï¼Œæ¯ä¸ªæœåŠ¡å™¨å®ä¾‹æœ€ç»ˆå¯èƒ½ä½¿ç”¨ä¸åŒçš„åŠ å¯†å¯†é’¥ï¼Œä»è€Œå¯¼è‡´æ½œåœ¨çš„ä¸ä¸€è‡´ã€‚

ä¸ºäº†ç¼“è§£è¿™ç§æƒ…å†µï¼Œæ‚¨å¯ä»¥ä½¿ç”¨`process.env.NEXT_SERVER_ACTIONS_ENCRYPTION_KEY`ç¯å¢ƒå˜é‡é‡å†™åŠ å¯†ç§˜é’¥ã€‚æŒ‡å®šæ­¤å˜é‡å¯ç¡®ä¿æ‚¨çš„åŠ å¯†å¯†é’¥åœ¨å„ä¸ªæ„å»ºä¸­éƒ½æ˜¯ä¸å˜çš„ï¼Œå¹¶ä¸”æ‰€æœ‰æœåŠ¡å™¨å®ä¾‹éƒ½ä½¿ç”¨ç›¸åŒçš„å¯†é’¥ã€‚

è¿™æ˜¯ä¸€ä¸ªé«˜çº§ç”¨ä¾‹ï¼Œå…¶ä¸­è·¨å¤šä¸ªéƒ¨ç½²çš„ä¸€è‡´åŠ å¯†è¡Œä¸ºå¯¹åº”ç”¨ç¨‹åºéå¸¸é‡è¦ã€‚æ‚¨åº”è¯¥è€ƒè™‘æ ‡å‡†çš„å®‰å…¨åšæ³•ï¼Œä¾‹å¦‚å¯†é’¥è½®æ¢å’Œç­¾åã€‚

> **ä½ éœ€è¦çŸ¥é“:** éƒ¨ç½²åˆ° Vercel çš„ Next.js åº”ç”¨ç¨‹åºä¼šè‡ªåŠ¨å¤„ç†è¿™ä¸ªé—®é¢˜ã€‚

### Allowed origins (é«˜çº§)

å› ä¸ºå¯ä»¥åœ¨`<form>`å…ƒç´ ä¸­è°ƒç”¨æœåŠ¡å™¨æ“ä½œï¼Œè¿™ä½¿å®ƒä»¬å®¹æ˜“å—åˆ°[CSRF æ”»å‡»](https://developer.mozilla.org/en-US/docs/Glossary/CSRF)ã€‚

åœ¨åå°, æœåŠ¡å™¨æ“ä½œä½¿ç”¨`POST`æ–¹æ³•, å¹¶ä¸”ä»…å…è®¸æ­¤ HTTP æ–¹æ³•è°ƒç”¨å®ƒä»¬ï¼Œè¿™é˜²æ­¢äº†ç°ä»£æµè§ˆå™¨ä¸­çš„å¤§å¤šæ•°çš„ CSRF æ¼æ´, å°¤å…¶æ˜¯[SameSite cookies](https://web.dev/articles/samesite-cookies-explained) æ˜¯é»˜è®¤è®¾ç½®ã€‚

ä½œä¸ºé¢å¤–çš„ä¿æŠ¤, Next.js ä¸­çš„æœåŠ¡å™¨æ“ä½œä¹Ÿä¼šä¹Ÿä¼šæ¯”è¾ƒ[Origin header](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Origin)å’Œ [Host header](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Host) (æˆ– `X-Forwarded-Host`)ã€‚å¦‚æœè¿™äº›ä¸åŒ¹é…, è¯·æ±‚å°†è¢«ç»ˆç«¯ã€‚æ¢å¥è¯è¯´ï¼ŒæœåŠ¡å™¨æ“ä½œåªèƒ½åœ¨æ‰˜ç®¡å®ƒçš„é¡µé¢ç›¸åŒçš„ä¸»æœºä¸Šè°ƒç”¨ã€‚

å¯¹äºä½¿ç”¨åå‘ä»£ç†æˆ–å¤šå±‚åç«¯æ¶æ„çš„å¤§å‹åº”ç”¨ç¨‹åºï¼ˆå…¶ä¸­æœåŠ¡å™¨ API ä¸ç”Ÿäº§åŸŸçš„ä¸åŒï¼‰ï¼Œæ¨èä½¿ç”¨é…ç½®é€‰é¡¹[`serverActions.allowedOrigins`](/docs/content/app/api-reference/next-config-js/serverActions)é€‰é¡¹æ¥æŒ‡å®šå®‰å…¨ origins åˆ—è¡¨ã€‚è¯¥é€‰é¡¹æ¥æ”¶å­—ç¬¦ä¸²æ•°ç»„ã€‚

```js filename="next.config.js"
/** @type {import('next').NextConfig} */
module.exports = {
  experimental: {
    serverActions: {
      allowedOrigins: ["my-proxy.com", "*.my-proxy.com"],
    },
  },
};
```

äº†è§£æœ‰å…³[å®‰å…¨å’ŒæœåŠ¡å™¨æ“ä½œ](https://nextjs.org/blog/security-nextjs-server-components-actions)çš„æ›´å¤šä¿¡æ¯ã€‚

## å…¶å®ƒèµ„æº

æœ‰å…³ Server Actions çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹ä»¥ä¸‹ React æ–‡æ¡£:

- [Server Actions](https://react.dev/reference/rsc/server-actions)
- [`"use server"`](https://react.dev/reference/react/use-server)
- [`<form>`](https://react.dev/reference/react-dom/components/form)
- [`useFormStatus`](https://react.dev/reference/react-dom/hooks/useFormStatus)
- [`useActionState`](https://react.dev/reference/react/useActionState)
- [`useOptimistic`](https://react.dev/reference/react/useOptimistic)
